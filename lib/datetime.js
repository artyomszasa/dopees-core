const regexJsonMilliseconds = /\.[0-9]+(Z|\+[0-9]{1,2}(:[0-9]{1,2})?)$/i;
const dateFromJson = (json) => {
    const fixed = json.replace(regexJsonMilliseconds, '$1');
    return new Date(fixed);
};
const dateFromTime = (milliseconds) => {
    const result = new Date();
    result.setTime(milliseconds);
    return result;
};
const regexTimeSpan = /^(-)?(([0-9]+)\.)?([0-9]{1,2}):([0-9]{1,2})(:([0-9]{1,2})(\.([0-9]{1,3}))?)?$/;
const monthLengths = [
    31,
    NaN,
    31,
    30,
    31,
    30,
    31,
    31,
    30,
    31,
    30,
    31 // dec
];
const pow10 = (n) => {
    switch (n) {
        case 0:
            return 1;
        case 1:
            return 10;
        case 2:
            return 100;
        case 3:
            return 1000;
        default:
            let res = 1;
            for (let i = 0; i < n; ++i) {
                res *= 10;
            }
            return res;
    }
};
const pad3 = (n) => {
    if (n < 10) {
        return `00${n}`;
    }
    if (n < 100) {
        return `0${n}`;
    }
    return String(n);
};
const parseTimeStamp = (input) => {
    const m = regexTimeSpan.exec(input);
    if (!m) {
        throw new Error(`invalid timestamp value: "${input}"`);
    }
    let milliseconds = m[9] ? parseInt(m[9], 10) * pow10(3 - m[9].length) : 0;
    milliseconds += (parseInt(m[7], 10) || 0) * TimeSpan.millisecondsInSecond;
    milliseconds += (parseInt(m[5], 10) || 0) * TimeSpan.millisecondsInMinute;
    milliseconds += (parseInt(m[4], 10) || 0) * TimeSpan.millisecondsInHour;
    milliseconds += (parseInt(m[3], 10) || 0) * TimeSpan.millisecondsInDay;
    if ('-' === m[1]) {
        milliseconds = -milliseconds;
    }
    return milliseconds;
};
export class TimeSpan {
    constructor(source) {
        if ('number' === typeof source) {
            this.value = source;
        }
        else {
            this.value = parseTimeStamp(source);
        }
    }
    get milliseconds() { return this.value % TimeSpan.millisecondsInSecond; }
    get seconds() { return Math.floor(this.totalSeconds) % 60; }
    get minutes() { return Math.floor(this.totalMinutes) % 60; }
    get hours() { return Math.floor(this.totalHours) % 24; }
    get days() { return Math.floor(this.totalDays); }
    get totalMilliseconds() { return this.value; }
    get totalSeconds() { return this.value / TimeSpan.millisecondsInSecond; }
    get totalMinutes() { return this.value / TimeSpan.millisecondsInMinute; }
    get totalHours() { return this.value / TimeSpan.millisecondsInHour; }
    get totalDays() { return this.value / TimeSpan.millisecondsInDay; }
    abs() {
        return new TimeSpan(Math.abs(this.value));
    }
    addMilliseconds(milliseconds) {
        return new TimeSpan(this.value + milliseconds);
    }
    addSeconds(seconds) {
        return this.addMilliseconds(seconds * TimeSpan.millisecondsInSecond);
    }
    addMinutes(minutes) {
        return this.addMilliseconds(minutes * TimeSpan.millisecondsInMinute);
    }
    addHours(hours) {
        return this.addMilliseconds(hours * TimeSpan.millisecondsInHour);
    }
    addDays(days) {
        return this.addMilliseconds(days * TimeSpan.millisecondsInDay);
    }
    add(value) {
        const milliseconds = value instanceof TimeSpan ? value.totalMilliseconds : value;
        return this.addMilliseconds(milliseconds);
    }
    neg() {
        return new TimeSpan(-1 * this.value);
    }
    subMilliseconds(milliseconds) {
        return new TimeSpan(this.value - milliseconds);
    }
    subSeconds(seconds) {
        return this.subMilliseconds(seconds * TimeSpan.millisecondsInSecond);
    }
    subMinutes(minutes) {
        return this.subMilliseconds(minutes * TimeSpan.millisecondsInMinute);
    }
    subHours(hours) {
        return this.subMilliseconds(hours * TimeSpan.millisecondsInHour);
    }
    subDays(days) {
        return this.subMilliseconds(days * TimeSpan.millisecondsInDay);
    }
    sub(value) {
        const milliseconds = value instanceof TimeSpan ? value.totalMilliseconds : value;
        return this.subMilliseconds(milliseconds);
    }
    equalsTo(other) {
        return this.value === other.value;
    }
    compareTo(other) {
        return this.value > other.value ? 1 : (this.value === other.value ? 0 : -1);
    }
    toString() {
        if (this.value < 0) {
            return `-${this.abs()}`;
        }
        const days = this.days;
        const hours = this.hours;
        const minutes = this.minutes;
        const seconds = this.seconds;
        const milliseconds = this.milliseconds;
        if (days) {
            if (seconds || !milliseconds) {
                return `${days}.${hours}.${minutes}.${seconds}`;
            }
            if (milliseconds) {
                return `${days}.${hours}.${minutes}.${seconds}.${pad3(milliseconds)}`;
            }
            return `${days}.${hours}.${minutes}`;
        }
        if (seconds || !milliseconds) {
            return `${hours}.${minutes}.${seconds}`;
        }
        if (milliseconds) {
            return `${hours}.${minutes}.${seconds}.${pad3(milliseconds)}`;
        }
        return `${hours}.${minutes}`;
    }
}
TimeSpan.millisecondsInSecond = 1000;
TimeSpan.millisecondsInMinute = 60000;
TimeSpan.millisecondsInHour = 3600000;
TimeSpan.millisecondsInDay = 86400000;
export class DateTime {
    /**
     * Returns amount of days in the specified month.
     * @param month Month.
     * @param year Year.
     */
    static getMonthLength(month, year) {
        if (month < 1 || month > 12) {
            throw new RangeError('month out of range');
        }
        if (month !== 2) {
            return monthLengths[month - 1];
        }
        return (0 === year % 4 && (0 !== year % 100 || 0 === year % 400)) ? 29 : 28;
    }
    get isValid() { return !isNaN(this.source.getTime()); }
    get year() { return this.source.getFullYear(); }
    get month() { return this.source.getMonth() + 1; }
    get day() { return this.source.getDate(); }
    get dayOfWeek() { return this.source.getDay(); }
    get hours() { return this.source.getHours(); }
    get minutes() { return this.source.getMinutes(); }
    get seconds() { return this.source.getSeconds(); }
    get milliseconds() { return this.source.getMilliseconds(); }
    constructor(source) {
        if (undefined === source || null === source) {
            this.source = new Date();
        }
        else if ('string' === typeof source) {
            this.source = dateFromJson(source);
        }
        else if ('number' === typeof source) {
            this.source = dateFromTime(source);
        }
        else if (source instanceof Date) {
            this.source = source;
        }
        else {
            // assume init
            const init = source;
            this.source = new Date(init.year || new Date().getFullYear(), init.month ? init.month - 1 : 0, init.day || 1, init.hours || 0, init.minutes || 0, init.seconds || 0, init.milliseconds || 0);
        }
    }
    equalsTo(other) {
        return this.source.getTime() === other.source.getTime();
    }
    compareTo(other) {
        return this.source < other.source ? -1 : (this.equalsTo(other) ? 0 : 1);
    }
    addMilliseconds(milliseconds) {
        const res = dateFromTime(this.source.getTime() + milliseconds);
        const offsetDelta = this.source.getTimezoneOffset() - res.getTimezoneOffset();
        if (offsetDelta !== 0) {
            const adjust = offsetDelta * TimeSpan.millisecondsInMinute;
            res.setTime(res.getTime() - adjust);
        }
        return new DateTime(res);
    }
    addSeconds(seconds) {
        return this.addMilliseconds(seconds * TimeSpan.millisecondsInSecond);
    }
    addMinutes(minutes) {
        return this.addMilliseconds(minutes * TimeSpan.millisecondsInMinute);
    }
    addHours(hours) {
        return this.addMilliseconds(hours * TimeSpan.millisecondsInHour);
    }
    addDays(days) {
        return this.addMilliseconds(days * TimeSpan.millisecondsInDay);
    }
    addMonths(months) {
        if (0 === months) {
            return this.addDays(0);
        }
        if (0 < months) {
            const full = Math.floor(months) + (this.month - 1);
            const fm = full % 12;
            const fy = Math.floor(full / 12);
            let res = new DateTime({
                year: this.year + fy,
                month: fm + 1,
                day: Math.min(DateTime.getMonthLength(fm + 1, this.year + fy), this.day),
                hours: this.hours,
                minutes: this.minutes,
                seconds: this.seconds,
                milliseconds: this.milliseconds
            });
            const part = months % 1;
            if (0 === part) {
                return res;
            }
            return res.addDays(DateTime.getMonthLength(res.month, res.year) * part);
        }
        else {
            const abs = Math.abs(months);
            let m = (this.month - 1) - Math.floor(abs);
            let y = this.year;
            while (0 > m) {
                y = y - 1;
                m = m + 12;
            }
            const part = abs % 1;
            if (0 === part) {
                return new DateTime({
                    year: y,
                    month: m + 1,
                    day: this.day,
                    hours: this.hours,
                    minutes: this.minutes,
                    seconds: this.seconds,
                    milliseconds: this.milliseconds
                });
            }
            if (0 === m) {
                y = y - 1;
                m = 11;
            }
            else {
                m = m - 1;
            }
            const days = DateTime.getMonthLength(m + 1, y);
            const toAdd = days * (1 - part);
            return new DateTime({
                year: y,
                month: m,
                day: this.day,
                hours: this.hours,
                minutes: this.minutes,
                seconds: this.seconds,
                milliseconds: this.milliseconds
            }).addDays(toAdd);
        }
    }
    add(value) {
        if (value instanceof TimeSpan) {
            return this.addMilliseconds(value.totalMilliseconds);
        }
        return this.addMilliseconds(value);
    }
    substract(value) {
        if (value instanceof DateTime) {
            return new TimeSpan(this.source.getTime() - value.source.getTime());
        }
        if (value instanceof TimeSpan) {
            return this.add(-1 * value.totalMilliseconds);
        }
        return this.add(-1 * value);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZXRpbWUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZGF0ZXRpbWUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsTUFBTSxxQkFBcUIsR0FBRywwQ0FBMEMsQ0FBQztBQUV6RSxNQUFNLFlBQVksR0FBRyxDQUFDLElBQVksRUFBRSxFQUFFO0lBQ3BDLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMscUJBQXFCLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDeEQsT0FBTyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUN6QixDQUFDLENBQUE7QUFFRCxNQUFNLFlBQVksR0FBRyxDQUFDLFlBQW9CLEVBQUUsRUFBRTtJQUM1QyxNQUFNLE1BQU0sR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO0lBQzFCLE1BQU0sQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDN0IsT0FBTyxNQUFNLENBQUM7QUFDaEIsQ0FBQyxDQUFBO0FBRUQsTUFBTSxhQUFhLEdBQUcsK0VBQStFLENBQUM7QUFFdEcsTUFBTSxZQUFZLEdBQUc7SUFDbkIsRUFBRTtJQUNGLEdBQUc7SUFDSCxFQUFFO0lBQ0YsRUFBRTtJQUNGLEVBQUU7SUFDRixFQUFFO0lBQ0YsRUFBRTtJQUNGLEVBQUU7SUFDRixFQUFFO0lBQ0YsRUFBRTtJQUNGLEVBQUU7SUFDRixFQUFFLENBQUUsTUFBTTtDQUNYLENBQUM7QUFFRixNQUFNLEtBQUssR0FBRyxDQUFDLENBQVMsRUFBRSxFQUFFO0lBQzFCLFFBQU8sQ0FBQyxFQUFFO1FBQ1IsS0FBSyxDQUFDO1lBQ0osT0FBTyxDQUFDLENBQUM7UUFDWCxLQUFLLENBQUM7WUFDSixPQUFPLEVBQUUsQ0FBQztRQUNaLEtBQUssQ0FBQztZQUNKLE9BQU8sR0FBRyxDQUFDO1FBQ2IsS0FBSyxDQUFDO1lBQ0osT0FBTyxJQUFJLENBQUM7UUFDZDtZQUNFLElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQztZQUNa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QUM7Z0JBQ1IsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHO2dCQUNiLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSztnQkFDakIsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPO2dCQUNyQixPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU87Z0JBQ3JCLFlBQVksRUFBRSxJQUFJLENBQUMsWUFBWTthQUNoQyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ25CO0lBQ0gsQ0FBQztJQUdELEdBQUcsQ0FBQyxLQUFzQjtRQUN4QixJQUFJLEtBQUssWUFBWSxRQUFRLEVBQUU7WUFDN0IsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1NBQ3REO1FBQ0QsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFJRCxTQUFTLENBQUMsS0FBK0I7UUFDdkMsSUFBSSxLQUFLLFlBQVksUUFBUSxFQUFFO1lBQzdCLE9BQU8sSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7U0FDckU7UUFDRCxJQUFJLEtBQUssWUFBWSxRQUFRLEVBQUU7WUFDN0IsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1NBQy9DO1FBQ0QsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDO0lBQzlCLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVxdWF0YWJsZSwgQ29tcGFyYWJsZSB9IGZyb20gXCIuL2NvbnRyYWN0XCI7XG5cbmNvbnN0IHJlZ2V4SnNvbk1pbGxpc2Vjb25kcyA9IC9cXC5bMC05XSsoWnxcXCtbMC05XXsxLDJ9KDpbMC05XXsxLDJ9KT8pJC9pO1xuXG5jb25zdCBkYXRlRnJvbUpzb24gPSAoanNvbjogc3RyaW5nKSA9PiB7XG4gIGNvbnN0IGZpeGVkID0ganNvbi5yZXBsYWNlKHJlZ2V4SnNvbk1pbGxpc2Vjb25kcywgJyQxJyk7XG4gIHJldHVybiBuZXcgRGF0ZShmaXhlZCk7XG59XG5cbmNvbnN0IGRhdGVGcm9tVGltZSA9IChtaWxsaXNlY29uZHM6IG51bWJlcikgPT4ge1xuICBjb25zdCByZXN1bHQgPSBuZXcgRGF0ZSgpO1xuICByZXN1bHQuc2V0VGltZShtaWxsaXNlY29uZHMpO1xuICByZXR1cm4gcmVzdWx0O1xufVxuXG5jb25zdCByZWdleFRpbWVTcGFuID0gL14oLSk/KChbMC05XSspXFwuKT8oWzAtOV17MSwyfSk6KFswLTldezEsMn0pKDooWzAtOV17MSwyfSkoXFwuKFswLTldezEsM30pKT8pPyQvO1xuXG5jb25zdCBtb250aExlbmd0aHMgPSBbXG4gIDMxLCAvLyBqYW5cbiAgTmFOLCAvLyBmZWJcbiAgMzEsICAvLyBtYXJcbiAgMzAsICAvLyBhcHJcbiAgMzEsICAvLyBtYXlcbiAgMzAsICAvLyBqdW5cbiAgMzEsICAvLyBqdWxcbiAgMzEsICAvLyBhdWdcbiAgMzAsICAvLyBzZXBcbiAgMzEsICAvLyBva3RcbiAgMzAsICAvLyBub3ZcbiAgMzEgIC8vIGRlY1xuXTtcblxuY29uc3QgcG93MTAgPSAobjogbnVtYmVyKSA9PiB7XG4gIHN3aXRjaChuKSB7XG4gICAgY2FzZSAwOlxuICAgICAgcmV0dXJuIDE7XG4gICAgY2FzZSAxOlxuICAgICAgcmV0dXJuIDEwO1xuICAgIGNhc2UgMjpcbiAgICAgIHJldHVybiAxMDA7XG4gICAgY2FzZSAzOlxuICAgICAgcmV0dXJuIDEwMDA7XG4gICAgZGVmYXVsdDpcbiAgICAgIGxldCByZXMgPSAxO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuOyArK2kpIHtcbiAgICAgICAgcmVzICo9IDEwO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHJlcztcbiAgfVxufVxuXG5jb25zdCBwYWQzID0gKG46IG51bWJlcikgPT4ge1xuICBpZiAobiA8IDEwKSB7XG4gICAgcmV0dXJuIGAwMCR7bn1gO1xuICB9XG4gIGlmIChuIDwgMTAwKSB7XG4gICAgcmV0dXJuIGAwJHtufWA7XG4gIH1cbiAgcmV0dXJuIFN0cmluZyhuKTtcbn1cblxuY29uc3QgcGFyc2VUaW1lU3RhbXAgPSAoaW5wdXQ6IHN0cmluZykgPT4ge1xuICBjb25zdCBtID0gcmVnZXhUaW1lU3Bhbi5leGVjKGlucHV0KTtcbiAgaWYgKCFtKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBpbnZhbGlkIHRpbWVzdGFtcCB2YWx1ZTogXCIke2lucHV0fVwiYCk7XG4gIH1cbiAgbGV0IG1pbGxpc2Vjb25kcyA9IG1bOV0gPyBwYXJzZUludChtWzldLCAxMCkgKiBwb3cxMCgzIC0gbVs5XS5sZW5ndGgpIDogMDtcbiAgbWlsbGlzZWNvbmRzICs9IChwYXJzZUludChtWzddLCAxMCkgfHwgMCkgKiBUaW1lU3Bhbi5taWxsaXNlY29uZHNJblNlY29uZDtcbiAgbWlsbGlzZWNvbmRzICs9IChwYXJzZUludChtWzVdLCAxMCkgfHwgMCkgKiBUaW1lU3Bhbi5taWxsaXNlY29uZHNJbk1pbnV0ZTtcbiAgbWlsbGlzZWNvbmRzICs9IChwYXJzZUludChtWzRdLCAxMCkgfHwgMCkgKiBUaW1lU3Bhbi5taWxsaXNlY29uZHNJbkhvdXI7XG4gIG1pbGxpc2Vjb25kcyArPSAocGFyc2VJbnQobVszXSwgMTApIHx8IDApICogVGltZVNwYW4ubWlsbGlzZWNvbmRzSW5EYXk7XG4gIGlmICgnLScgPT09IG1bMV0pIHtcbiAgICBtaWxsaXNlY29uZHMgPSAtbWlsbGlzZWNvbmRzO1xuICB9XG4gIHJldHVybiBtaWxsaXNlY29uZHM7XG59XG5cbmV4cG9ydCBjbGFzcyBUaW1lU3BhbiBpbXBsZW1lbnRzIEVxdWF0YWJsZTxUaW1lU3Bhbj4sIENvbXBhcmFibGU8VGltZVNwYW4+IHtcbiAgc3RhdGljIHJlYWRvbmx5IG1pbGxpc2Vjb25kc0luU2Vjb25kID0gMTAwMDtcbiAgc3RhdGljIHJlYWRvbmx5IG1pbGxpc2Vjb25kc0luTWludXRlID0gNjAwMDA7XG4gIHN0YXRpYyByZWFkb25seSBtaWxsaXNlY29uZHNJbkhvdXIgPSAzNjAwMDAwO1xuICBzdGF0aWMgcmVhZG9ubHkgbWlsbGlzZWNvbmRzSW5EYXkgPSA4NjQwMDAwMDtcbiAgcHJpdmF0ZSByZWFkb25seSB2YWx1ZTogbnVtYmVyXG4gIGdldCBtaWxsaXNlY29uZHMoKSB7IHJldHVybiB0aGlzLnZhbHVlICUgVGltZVNwYW4ubWlsbGlzZWNvbmRzSW5TZWNvbmQ7IH1cbiAgZ2V0IHNlY29uZHMoKSB7IHJldHVybiBNYXRoLmZsb29yKHRoaXMudG90YWxTZWNvbmRzKSAlIDYwOyB9XG4gIGdldCBtaW51dGVzKCkgeyByZXR1cm4gTWF0aC5mbG9vcih0aGlzLnRvdGFsTWludXRlcykgJSA2MDsgfVxuICBnZXQgaG91cnMoKSB7IHJldHVybiBNYXRoLmZsb29yKHRoaXMudG90YWxIb3VycykgJSAyNDsgfVxuICBnZXQgZGF5cygpIHsgcmV0dXJuIE1hdGguZmxvb3IodGhpcy50b3RhbERheXMpOyB9XG4gIGdldCB0b3RhbE1pbGxpc2Vjb25kcygpIHsgcmV0dXJuIHRoaXMudmFsdWU7IH1cbiAgZ2V0IHRvdGFsU2Vjb25kcygpIHsgcmV0dXJuIHRoaXMudmFsdWUgLyBUaW1lU3Bhbi5taWxsaXNlY29uZHNJblNlY29uZDsgfVxuICBnZXQgdG90YWxNaW51dGVzKCkgeyByZXR1cm4gdGhpcy52YWx1ZSAvIFRpbWVTcGFuLm1pbGxpc2Vjb25kc0luTWludXRlOyB9XG4gIGdldCB0b3RhbEhvdXJzKCkgeyByZXR1cm4gdGhpcy52YWx1ZSAvIFRpbWVTcGFuLm1pbGxpc2Vjb25kc0luSG91cjsgfVxuICBnZXQgdG90YWxEYXlzKCkgeyByZXR1cm4gdGhpcy52YWx1ZSAvIFRpbWVTcGFuLm1pbGxpc2Vjb25kc0luRGF5OyB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgdGltZXNwYW4gZm9yIHRoZSBzcGVjaWZpZWQgYW1vdW50IG9mIG1pbGxpc2Vjb25kcy5cbiAgICogQHBhcmFtIG1pbGxpc2Vjb25kcyBBbW91bnQgb2YgbWlsbGlzZWNvbmRzLlxuICAgKi9cbiAgY29uc3RydWN0b3IobWlsbGlzZWNvbmRzOiBudW1iZXIpO1xuXG4gIC8qKlxuICAgKiBDcmVhdGVzIHRpbWVzcGFuIGJ5IHBhcnNpbmcgaXRzIHN0cmluZyByZXByZXNlbnRhdGlvbi5cbiAgICogQHBhcmFtIGlucHV0IFN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgdGltZXNwYW4uXG4gICAqL1xuICBjb25zdHJ1Y3RvcihpbnB1dDogc3RyaW5nKTtcblxuICBjb25zdHJ1Y3Rvcihzb3VyY2U6IG51bWJlcnxzdHJpbmcpIHtcbiAgICBpZiAoJ251bWJlcicgPT09IHR5cGVvZiBzb3VyY2UpIHtcbiAgICAgIHRoaXMudmFsdWUgPSBzb3VyY2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudmFsdWUgPSBwYXJzZVRpbWVTdGFtcChzb3VyY2UpO1xuICAgIH1cbiAgfVxuICBhYnMoKSB7XG4gICAgcmV0dXJuIG5ldyBUaW1lU3BhbihNYXRoLmFicyh0aGlzLnZhbHVlKSk7XG4gIH1cbiAgYWRkTWlsbGlzZWNvbmRzKG1pbGxpc2Vjb25kczogbnVtYmVyKSB7XG4gICAgcmV0dXJuIG5ldyBUaW1lU3Bhbih0aGlzLnZhbHVlICsgbWlsbGlzZWNvbmRzKTtcbiAgfVxuICBhZGRTZWNvbmRzKHNlY29uZHM6IG51bWJlcikge1xuICAgIHJldHVybiB0aGlzLmFkZE1pbGxpc2Vjb25kcyhzZWNvbmRzICogVGltZVNwYW4ubWlsbGlzZWNvbmRzSW5TZWNvbmQpO1xuICB9XG4gIGFkZE1pbnV0ZXMobWludXRlczogbnVtYmVyKSB7XG4gICAgcmV0dXJuIHRoaXMuYWRkTWlsbGlzZWNvbmRzKG1pbnV0ZXMgKiBUaW1lU3Bhbi5taWxsaXNlY29uZHNJbk1pbnV0ZSk7XG4gIH1cbiAgYWRkSG91cnMoaG91cnM6IG51bWJlcikge1xuICAgIHJldHVybiB0aGlzLmFkZE1pbGxpc2Vjb25kcyhob3VycyAqIFRpbWVTcGFuLm1pbGxpc2Vjb25kc0luSG91cik7XG4gIH1cbiAgYWRkRGF5cyhkYXlzOiBudW1iZXIpIHtcbiAgICByZXR1cm4gdGhpcy5hZGRNaWxsaXNlY29uZHMoZGF5cyAqIFRpbWVTcGFuLm1pbGxpc2Vjb25kc0luRGF5KTtcbiAgfVxuICBhZGQodmFsdWU6IFRpbWVTcGFufG51bWJlcikge1xuICAgIGNvbnN0IG1pbGxpc2Vjb25kcyA9IHZhbHVlIGluc3RhbmNlb2YgVGltZVNwYW4gPyB2YWx1ZS50b3RhbE1pbGxpc2Vjb25kcyA6IHZhbHVlO1xuICAgIHJldHVybiB0aGlzLmFkZE1pbGxpc2Vjb25kcyhtaWxsaXNlY29uZHMpO1xuICB9XG4gIG5lZygpIHtcbiAgICByZXR1cm4gbmV3IFRpbWVTcGFuKC0xICogdGhpcy52YWx1ZSk7XG4gIH1cbiAgc3ViTWlsbGlzZWNvbmRzKG1pbGxpc2Vjb25kczogbnVtYmVyKSB7XG4gICAgcmV0dXJuIG5ldyBUaW1lU3Bhbih0aGlzLnZhbHVlIC0gbWlsbGlzZWNvbmRzKTtcbiAgfVxuICBzdWJTZWNvbmRzKHNlY29uZHM6IG51bWJlcikge1xuICAgIHJldHVybiB0aGlzLnN1Yk1pbGxpc2Vjb25kcyhzZWNvbmRzICogVGltZVNwYW4ubWlsbGlzZWNvbmRzSW5TZWNvbmQpO1xuICB9XG4gIHN1Yk1pbnV0ZXMobWludXRlczogbnVtYmVyKSB7XG4gICAgcmV0dXJuIHRoaXMuc3ViTWlsbGlzZWNvbmRzKG1pbnV0ZXMgKiBUaW1lU3Bhbi5taWxsaXNlY29uZHNJbk1pbnV0ZSk7XG4gIH1cbiAgc3ViSG91cnMoaG91cnM6IG51bWJlcikge1xuICAgIHJldHVybiB0aGlzLnN1Yk1pbGxpc2Vjb25kcyhob3VycyAqIFRpbWVTcGFuLm1pbGxpc2Vjb25kc0luSG91cik7XG4gIH1cbiAgc3ViRGF5cyhkYXlzOiBudW1iZXIpIHtcbiAgICByZXR1cm4gdGhpcy5zdWJNaWxsaXNlY29uZHMoZGF5cyAqIFRpbWVTcGFuLm1pbGxpc2Vjb25kc0luRGF5KTtcbiAgfVxuICBzdWIodmFsdWU6IFRpbWVTcGFufG51bWJlcikge1xuICAgIGNvbnN0IG1pbGxpc2Vjb25kcyA9IHZhbHVlIGluc3RhbmNlb2YgVGltZVNwYW4gPyB2YWx1ZS50b3RhbE1pbGxpc2Vjb25kcyA6IHZhbHVlO1xuICAgIHJldHVybiB0aGlzLnN1Yk1pbGxpc2Vjb25kcyhtaWxsaXNlY29uZHMpO1xuICB9XG5cbiAgZXF1YWxzVG8ob3RoZXI6IFRpbWVTcGFuKSB7XG4gICAgcmV0dXJuIHRoaXMudmFsdWUgPT09IG90aGVyLnZhbHVlO1xuICB9XG5cbiAgY29tcGFyZVRvKG90aGVyOiBUaW1lU3Bhbikge1xuICAgIHJldHVybiB0aGlzLnZhbHVlID4gb3RoZXIudmFsdWUgPyAxIDogKHRoaXMudmFsdWUgPT09IG90aGVyLnZhbHVlID8gMCA6IC0xKTtcbiAgfVxuXG4gIHRvU3RyaW5nKCkge1xuICAgIGlmICh0aGlzLnZhbHVlIDwgMCkge1xuICAgICAgcmV0dXJuIGAtJHt0aGlzLmFicygpfWA7XG4gICAgfVxuICAgIGNvbnN0IGRheXMgPSB0aGlzLmRheXM7XG4gICAgY29uc3QgaG91cnMgPSB0aGlzLmhvdXJzO1xuICAgIGNvbnN0IG1pbnV0ZXMgPSB0aGlzLm1pbnV0ZXM7XG4gICAgY29uc3Qgc2Vjb25kcyA9IHRoaXMuc2Vjb25kcztcbiAgICBjb25zdCBtaWxsaXNlY29uZHMgPSB0aGlzLm1pbGxpc2Vjb25kcztcbiAgICBpZiAoZGF5cykge1xuICAgICAgaWYgKHNlY29uZHMgfHwgIW1pbGxpc2Vjb25kcykge1xuICAgICAgICByZXR1cm4gYCR7ZGF5c30uJHtob3Vyc30uJHttaW51dGVzfS4ke3NlY29uZHN9YDtcbiAgICAgIH1cbiAgICAgIGlmIChtaWxsaXNlY29uZHMpIHtcbiAgICAgICAgcmV0dXJuIGAke2RheXN9LiR7aG91cnN9LiR7bWludXRlc30uJHtzZWNvbmRzfS4ke3BhZDMobWlsbGlzZWNvbmRzKX1gO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGAke2RheXN9LiR7aG91cnN9LiR7bWludXRlc31gO1xuICAgIH1cbiAgICBpZiAoc2Vjb25kcyB8fCAhbWlsbGlzZWNvbmRzKSB7XG4gICAgICByZXR1cm4gYCR7aG91cnN9LiR7bWludXRlc30uJHtzZWNvbmRzfWA7XG4gICAgfVxuICAgIGlmIChtaWxsaXNlY29uZHMpIHtcbiAgICAgIHJldHVybiBgJHtob3Vyc30uJHttaW51dGVzfS4ke3NlY29uZHN9LiR7cGFkMyhtaWxsaXNlY29uZHMpfWA7XG4gICAgfVxuICAgIHJldHVybiBgJHtob3Vyc30uJHttaW51dGVzfWA7XG4gIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBEYXRlVGltZUluaXQge1xuICB5ZWFyPzogbnVtYmVyO1xuICBtb250aD86IG51bWJlcjtcbiAgZGF5PzogbnVtYmVyO1xuICBob3Vycz86IG51bWJlcjtcbiAgbWludXRlcz86IG51bWJlcjtcbiAgc2Vjb25kcz86IG51bWJlcjtcbiAgbWlsbGlzZWNvbmRzPzogbnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgRGF0ZVRpbWUgaW1wbGVtZW50cyBFcXVhdGFibGU8RGF0ZVRpbWU+LCBDb21wYXJhYmxlPERhdGVUaW1lPiB7XG4gIC8qKlxuICAgKiBSZXR1cm5zIGFtb3VudCBvZiBkYXlzIGluIHRoZSBzcGVjaWZpZWQgbW9udGguXG4gICAqIEBwYXJhbSBtb250aCBNb250aC5cbiAgICogQHBhcmFtIHllYXIgWWVhci5cbiAgICovXG4gIHN0YXRpYyBnZXRNb250aExlbmd0aChtb250aDogbnVtYmVyLCB5ZWFyOiBudW1iZXIpIHtcbiAgICBpZiAobW9udGggPCAxIHx8IG1vbnRoID4gMTIpIHtcbiAgICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ21vbnRoIG91dCBvZiByYW5nZScpO1xuICAgIH1cbiAgICBpZiAobW9udGggIT09IDIpIHtcbiAgICAgICAgcmV0dXJuIG1vbnRoTGVuZ3Roc1ttb250aCAtIDFdO1xuICAgIH1cbiAgICByZXR1cm4gKDAgPT09IHllYXIgJSA0ICYmICgwICE9PSB5ZWFyICUgMTAwIHx8IDAgPT09IHllYXIgJSA0MDApKSA/IDI5IDogMjg7XG59XG5cbiAgcHJpdmF0ZSByZWFkb25seSBzb3VyY2U6IERhdGVcbiAgZ2V0IGlzVmFsaWQoKSB7IHJldHVybiAhaXNOYU4odGhpcy5zb3VyY2UuZ2V0VGltZSgpKTsgfVxuICBnZXQgeWVhcigpIHsgcmV0dXJuIHRoaXMuc291cmNlLmdldEZ1bGxZZWFyKCk7IH1cbiAgZ2V0IG1vbnRoKCkgeyByZXR1cm4gdGhpcy5zb3VyY2UuZ2V0TW9udGgoKSArIDE7IH1cbiAgZ2V0IGRheSgpIHsgcmV0dXJuIHRoaXMuc291cmNlLmdldERhdGUoKTsgfVxuICBnZXQgZGF5T2ZXZWVrKCkgeyByZXR1cm4gdGhpcy5zb3VyY2UuZ2V0RGF5KCk7IH1cbiAgZ2V0IGhvdXJzKCkgeyByZXR1cm4gdGhpcy5zb3VyY2UuZ2V0SG91cnMoKTsgfVxuICBnZXQgbWludXRlcygpIHsgcmV0dXJuIHRoaXMuc291cmNlLmdldE1pbnV0ZXMoKTsgfVxuICBnZXQgc2Vjb25kcygpIHsgcmV0dXJuIHRoaXMuc291cmNlLmdldFNlY29uZHMoKTsgfVxuICBnZXQgbWlsbGlzZWNvbmRzKCkgeyByZXR1cm4gdGhpcy5zb3VyY2UuZ2V0TWlsbGlzZWNvbmRzKCk7IH1cblxuICAvKiogQ3JlYXRlcyBuZXcgaW5zdGFuY2Ugb2YgZGF0ZXRpbWUgZm9yIGFjdHVhbCBkYXRlIGFuZCB0aW1lLiAqL1xuICBjb25zdHJ1Y3RvcigpO1xuXG4gIC8qKlxuICAgKiBDcmVhdGVzIG5ldyBpbnN0YW5jZSBvZiBkYXRldGltZSBmcm9tIHRoZSBzcGVjaWZpZWQgZGF0ZS5cbiAgICogQHBhcmFtIHNvdXJjZSBEYXRlIG9iamVjdCB0byB1c2UuXG4gICAqL1xuICBjb25zdHJ1Y3Rvcihzb3VyY2U6IERhdGUpO1xuXG4gIC8qKlxuICAgKiBDcmVhdGVzIG5ldyBpbnN0YW5jZSBvZiBkYXRldGltZSBmcm9tIHRoZSBzcGVjaWZpZWQgSlNPTiBzdHJpbmcgcmVwcmVzZW50aW5nIGRhdGUuXG4gICAqIEBwYXJhbSBqc29uIEpTT04gc3RyaW5nIHJlcHJlc2VudGluZyBkYXRlLlxuICAgKi9cbiAgY29uc3RydWN0b3IoanNvbjogc3RyaW5nKTtcblxuICAvKipcbiAgICogQ3JlYXRlcyBuZXcgaW5zdGFuY2Ugb2YgZGF0ZXRpbWUgZnJvbSB0aGUgc3BlY2lmaWVkIGFtb3VudCBvZiBtaWxsaXNlY29uZHMgZnJvbSAxOTcwIGphbiAxIFVUQy5cbiAgICogQHBhcmFtIHNvdXJjZSBBbW91bnQgb2YgbWlsbGlzZWNvbmRzIGZyb20gMTk3MCBqYW4gMSBVVEMuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihtaWxsaXNlY29uZHM6IG51bWJlcik7XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgbmV3IGluc3RhbmNlIG9mIGRhdGV0aW1lIGZyb20gdGhlIHNwZWNpZmllZCBpbml0aWFsaXplci5cbiAgICogQHBhcmFtIHNvdXJjZSBJbml0aWFsaXplciBvYmplY3QgdG8gdXNlLlxuICAgKi9cbiAgY29uc3RydWN0b3IoaW5pdDogRGF0ZVRpbWVJbml0KTtcblxuICBjb25zdHJ1Y3RvciAoc291cmNlPzogRGF0ZXxzdHJpbmd8bnVtYmVyfERhdGVUaW1lSW5pdCkge1xuICAgIGlmICh1bmRlZmluZWQgPT09IHNvdXJjZSB8fCBudWxsID09PSBzb3VyY2UpIHtcbiAgICAgIHRoaXMuc291cmNlID0gbmV3IERhdGUoKTtcbiAgICB9IGVsc2UgaWYgKCdzdHJpbmcnID09PSB0eXBlb2Ygc291cmNlKSB7XG4gICAgICB0aGlzLnNvdXJjZSA9IGRhdGVGcm9tSnNvbihzb3VyY2UpO1xuICAgIH0gZWxzZSBpZiAoJ251bWJlcicgPT09IHR5cGVvZiBzb3VyY2UpIHtcbiAgICAgIHRoaXMuc291cmNlID0gZGF0ZUZyb21UaW1lKHNvdXJjZSk7XG4gICAgfSBlbHNlIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBEYXRlKSB7XG4gICAgICB0aGlzLnNvdXJjZSA9IHNvdXJjZTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gYXNzdW1lIGluaXRcbiAgICAgIGNvbnN0IGluaXQgPSA8RGF0ZVRpbWVJbml0PnNvdXJjZTtcbiAgICAgIHRoaXMuc291cmNlID0gbmV3IERhdGUoaW5pdC55ZWFyIHx8IG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKSwgaW5pdC5tb250aCA/IGluaXQubW9udGggLSAxIDogMCwgaW5pdC5kYXkgfHwgMSwgaW5pdC5ob3VycyB8fCAwLCBpbml0Lm1pbnV0ZXMgfHwgMCwgaW5pdC5zZWNvbmRzIHx8IDAsIGluaXQubWlsbGlzZWNvbmRzIHx8IDApO1xuICAgIH1cbiAgfVxuXG4gIGVxdWFsc1RvKG90aGVyOiBEYXRlVGltZSkge1xuICAgIHJldHVybiB0aGlzLnNvdXJjZS5nZXRUaW1lKCkgPT09IG90aGVyLnNvdXJjZS5nZXRUaW1lKCk7XG4gIH1cblxuICBjb21wYXJlVG8ob3RoZXI6IERhdGVUaW1lKSB7XG4gICAgcmV0dXJuIHRoaXMuc291cmNlIDwgb3RoZXIuc291cmNlID8gLTEgOiAodGhpcy5lcXVhbHNUbyhvdGhlcikgPyAwIDogMSk7XG4gIH1cblxuICBhZGRNaWxsaXNlY29uZHMobWlsbGlzZWNvbmRzOiBudW1iZXIpIHtcbiAgICBjb25zdCByZXMgPSBkYXRlRnJvbVRpbWUodGhpcy5zb3VyY2UuZ2V0VGltZSgpICsgbWlsbGlzZWNvbmRzKTtcbiAgICBjb25zdCBvZmZzZXREZWx0YSA9IHRoaXMuc291cmNlLmdldFRpbWV6b25lT2Zmc2V0KCkgLSByZXMuZ2V0VGltZXpvbmVPZmZzZXQoKTtcbiAgICBpZiAob2Zmc2V0RGVsdGEgIT09IDApIHtcbiAgICAgICAgY29uc3QgYWRqdXN0ID0gb2Zmc2V0RGVsdGEgKiBUaW1lU3Bhbi5taWxsaXNlY29uZHNJbk1pbnV0ZTtcbiAgICAgICAgcmVzLnNldFRpbWUocmVzLmdldFRpbWUoKSAtIGFkanVzdCk7XG4gICAgfVxuICAgIHJldHVybiBuZXcgRGF0ZVRpbWUocmVzKTtcbiAgfVxuXG4gIGFkZFNlY29uZHMoc2Vjb25kczogbnVtYmVyKSB7XG4gICAgcmV0dXJuIHRoaXMuYWRkTWlsbGlzZWNvbmRzKHNlY29uZHMgKiBUaW1lU3Bhbi5taWxsaXNlY29uZHNJblNlY29uZCk7XG4gIH1cblxuICBhZGRNaW51dGVzKG1pbnV0ZXM6IG51bWJlcikge1xuICAgIHJldHVybiB0aGlzLmFkZE1pbGxpc2Vjb25kcyhtaW51dGVzICogVGltZVNwYW4ubWlsbGlzZWNvbmRzSW5NaW51dGUpO1xuICB9XG5cbiAgYWRkSG91cnMoaG91cnM6IG51bWJlcikge1xuICAgIHJldHVybiB0aGlzLmFkZE1pbGxpc2Vjb25kcyhob3VycyAqIFRpbWVTcGFuLm1pbGxpc2Vjb25kc0luSG91cik7XG4gIH1cblxuICBhZGREYXlzKGRheXM6IG51bWJlcikge1xuICAgIHJldHVybiB0aGlzLmFkZE1pbGxpc2Vjb25kcyhkYXlzICogVGltZVNwYW4ubWlsbGlzZWNvbmRzSW5EYXkpO1xuICB9XG5cbiAgYWRkTW9udGhzKG1vbnRoczogbnVtYmVyKSB7XG4gICAgaWYgKDAgPT09IG1vbnRocykge1xuICAgICAgICByZXR1cm4gdGhpcy5hZGREYXlzKDApO1xuICAgIH1cbiAgICBpZiAoMCA8IG1vbnRocykge1xuICAgICAgY29uc3QgZnVsbCA9IE1hdGguZmxvb3IobW9udGhzKSArICh0aGlzLm1vbnRoIC0gMSk7XG4gICAgICBjb25zdCBmbSA9IGZ1bGwgJSAxMjtcbiAgICAgIGNvbnN0IGZ5ID0gTWF0aC5mbG9vcihmdWxsIC8gMTIpO1xuICAgICAgbGV0IHJlcyA9IG5ldyBEYXRlVGltZSh7XG4gICAgICAgIHllYXI6IHRoaXMueWVhciArIGZ5LFxuICAgICAgICBtb250aDogZm0gKyAxLFxuICAgICAgICBkYXk6IE1hdGgubWluKERhdGVUaW1lLmdldE1vbnRoTGVuZ3RoKGZtICsgMSwgdGhpcy55ZWFyICsgZnkpLCB0aGlzLmRheSksXG4gICAgICAgIGhvdXJzOiB0aGlzLmhvdXJzLFxuICAgICAgICBtaW51dGVzOiB0aGlzLm1pbnV0ZXMsXG4gICAgICAgIHNlY29uZHM6IHRoaXMuc2Vjb25kcyxcbiAgICAgICAgbWlsbGlzZWNvbmRzOiB0aGlzLm1pbGxpc2Vjb25kc1xuICAgICAgfSk7XG4gICAgICBjb25zdCBwYXJ0ID0gbW9udGhzICUgMTtcbiAgICAgIGlmICgwID09PSBwYXJ0KSB7XG4gICAgICAgIHJldHVybiByZXM7XG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzLmFkZERheXMoRGF0ZVRpbWUuZ2V0TW9udGhMZW5ndGgocmVzLm1vbnRoLCByZXMueWVhcikgKiBwYXJ0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgYWJzID0gTWF0aC5hYnMobW9udGhzKTtcbiAgICAgIGxldCBtID0gKHRoaXMubW9udGggLSAxKSAtIE1hdGguZmxvb3IoYWJzKTtcbiAgICAgIGxldCB5ID0gdGhpcy55ZWFyO1xuICAgICAgd2hpbGUgKDAgPiBtKSB7XG4gICAgICAgIHkgPSB5IC0gMTtcbiAgICAgICAgbSA9IG0gKyAxMjtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHBhcnQgPSBhYnMgJSAxO1xuICAgICAgaWYgKDAgPT09IHBhcnQpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBEYXRlVGltZSh7XG4gICAgICAgICAgeWVhcjogeSxcbiAgICAgICAgICBtb250aDogbSArIDEsXG4gICAgICAgICAgZGF5OiB0aGlzLmRheSxcbiAgICAgICAgICBob3VyczogdGhpcy5ob3VycyxcbiAgICAgICAgICBtaW51dGVzOiB0aGlzLm1pbnV0ZXMsXG4gICAgICAgICAgc2Vjb25kczogdGhpcy5zZWNvbmRzLFxuICAgICAgICAgIG1pbGxpc2Vjb25kczogdGhpcy5taWxsaXNlY29uZHNcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBpZiAoMCA9PT0gbSkge1xuICAgICAgICAgIHkgPSB5IC0gMTtcbiAgICAgICAgICBtID0gMTE7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAgIG0gPSBtIC0gMTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGRheXMgPSBEYXRlVGltZS5nZXRNb250aExlbmd0aChtICsgMSwgeSk7XG4gICAgICBjb25zdCB0b0FkZCA9IGRheXMgKiAoMSAtIHBhcnQpO1xuICAgICAgcmV0dXJuIG5ldyBEYXRlVGltZSh7XG4gICAgICAgIHllYXI6IHksXG4gICAgICAgIG1vbnRoOiBtLFxuICAgICAgICBkYXk6IHRoaXMuZGF5LFxuICAgICAgICBob3VyczogdGhpcy5ob3VycyxcbiAgICAgICAgbWludXRlczogdGhpcy5taW51dGVzLFxuICAgICAgICBzZWNvbmRzOiB0aGlzLnNlY29uZHMsXG4gICAgICAgIG1pbGxpc2Vjb25kczogdGhpcy5taWxsaXNlY29uZHNcbiAgICAgIH0pLmFkZERheXModG9BZGQpO1xuICAgIH1cbiAgfVxuICBhZGQodGltZVNwYW46IFRpbWVTcGFuKTogRGF0ZVRpbWU7XG4gIGFkZChtaWxsaXNlY29uZHM6IG51bWJlcik6IERhdGVUaW1lO1xuICBhZGQodmFsdWU6IFRpbWVTcGFufG51bWJlcikge1xuICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFRpbWVTcGFuKSB7XG4gICAgICByZXR1cm4gdGhpcy5hZGRNaWxsaXNlY29uZHModmFsdWUudG90YWxNaWxsaXNlY29uZHMpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5hZGRNaWxsaXNlY29uZHModmFsdWUpO1xuICB9XG4gIHN1YnN0cmFjdChvdGhlcjogRGF0ZVRpbWUpOiBUaW1lU3BhbjtcbiAgc3Vic3RyYWN0KHRpbWVzcGFuOiBUaW1lU3Bhbik6IERhdGVUaW1lO1xuICBzdWJzdHJhY3QobWlsbGlzZWNvbmRzOiBudW1iZXIpOiBEYXRlVGltZTtcbiAgc3Vic3RyYWN0KHZhbHVlOiBEYXRlVGltZXxUaW1lU3BhbnxudW1iZXIpIHtcbiAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBEYXRlVGltZSkge1xuICAgICAgcmV0dXJuIG5ldyBUaW1lU3Bhbih0aGlzLnNvdXJjZS5nZXRUaW1lKCkgLSB2YWx1ZS5zb3VyY2UuZ2V0VGltZSgpKTtcbiAgICB9XG4gICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgVGltZVNwYW4pIHtcbiAgICAgIHJldHVybiB0aGlzLmFkZCgtMSAqIHZhbHVlLnRvdGFsTWlsbGlzZWNvbmRzKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuYWRkKC0xICogdmFsdWUpO1xuICB9XG59Il19