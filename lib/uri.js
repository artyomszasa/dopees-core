// see: https://tools.ietf.org/html/rfc3986
const regexUri = /^(([a-z][a-z0-9+.-]*):)?(\/\/(([!$&\\'()*,;=a-z0-9._~-]|%[0-9a-f][0-9a-f])*)(\:([0-9]+))?)?(([\/!$&\\'()*,;=:@a-z0-9._~-]|%[0-9a-f][0-9a-f])*)(\?([!$&\\'()*,;=:@a-z0-9._~\/?-]|%[0-9a-f][0-9a-f])*)?(\#.*)?$/i;
const parseQuery = (params, raw) => {
    raw
        .split('&')
        .forEach(one => {
        if (one) {
            const i = one.indexOf('=');
            if (-1 === i) {
                params[one] = null;
            }
            else {
                params[one.substring(0, i)] = decodeURIComponent(one.substring(i + 1));
            }
        }
    });
};
const parse = (uri, raw) => {
    const m = regexUri.exec(raw);
    if (m) {
        uri.scheme = m[2];
        uri.host = m[4];
        uri.path = m[8];
        uri.port = parseInt(m[7], 10) || Uri.defaultPorts[uri.scheme] || 0;
        uri.query = (m[10] && m[10].substr(1) || '');
        uri.fragment = (m[12] && m[12].substr(1) || '');
    }
};
/**
* Simple and straightforward Uri wrapper.
*
* @class dope.Uri
* @param {String} raw - string representation of the Uri.
*/
export class Uri {
    constructor(raw) {
        this._queryParams = {};
        parse(this, raw);
    }
    /** Gets or sets query component of the Uri as object. Allows accessing and
     * manipulating individual arguments within query component. */
    get queryParams() {
        return this._queryParams;
    }
    set queryParams(value) {
        this._queryParams = value || {};
    }
    /**
     * Creates {@link Uri} form an argument.
     *
     * @param {string|Uri} uri - Source uri.
     */
    static from(uri) {
        if (uri instanceof Uri) {
            return uri;
        }
        return new Uri(uri);
    }
    /**
     * Is _true_ if the wrapper Uri is relative.
     *
     * @type {Boolean}
     * @readonly
     */
    get isRelative() {
        return !this.scheme;
    }
    /**
     * Is _true_ if the wrapper Uri is absolute.
     *
     * @type {Boolean}
     * @readonly
     */
    get isAbsolute() {
        return !!this.scheme;
    }
    /**
     * Gets or sets authority of the Uri (i.e. hostname and port if non standard).
     *
     * @type {String}
     */
    get authority() {
        if (this.port && this.scheme && this.port !== Uri.defaultPorts[this.scheme]) {
            return `${this.host}:${this.port}`;
        }
        return this.host || '';
    }
    set authority(authority) {
        const i = authority.indexOf(':');
        if (-1 === i) {
            this.host = authority;
            this.port = 0;
        }
        else {
            this.host = authority.substr(0, i);
            this.port = parseInt(authority.substr(i + 1), 10) || 0;
        }
    }
    /**
     * Gets or sets the wrapped Uri.
     *
     * @type {String}
     */
    get href() {
        const query = this.query;
        const queryString = query ? `?${query}` : '';
        const fragment = this.fragment ? `#${this.fragment}` : '';
        const authority = this.authority ? `//${this.authority}` : '';
        const scheme = this.scheme ? `${this.scheme}:` : '';
        return `${scheme}${authority}${this.path}${queryString}${fragment}`;
    }
    set href(href) {
        parse(this, href);
    }
    /**
     * Gets or sets query component of the Uri. To access or manipulate individual query arguments use
     * {@link dope.Uri#queryParams}.
     *
     * @type {String}
     */
    get query() {
        const queryParams = this._queryParams || {};
        return Object.keys(queryParams)
            .map(key => {
            const val = queryParams[key];
            return val ? `${encodeURIComponent(key)}=${encodeURIComponent(val)}` : `${encodeURIComponent(key)}=`;
        })
            .join('&');
    }
    set query(query) {
        this._queryParams = {};
        parseQuery(this._queryParams, query);
    }
    toString() {
        return this.href;
    }
}
Uri.defaultPorts = {
    'http': 80,
    'https': 443
};
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXJpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3VyaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSwyQ0FBMkM7QUFDM0MsTUFBTSxRQUFRLEdBQUcsZ05BQWdOLENBQUM7QUFXbE8sTUFBTSxVQUFVLEdBQUcsQ0FBQyxNQUFpQixFQUFFLEdBQVcsRUFBRSxFQUFFO0lBQ3BELEdBQUc7U0FDRSxLQUFLLENBQUMsR0FBRyxDQUFDO1NBQ1YsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1FBQ1gsSUFBSSxHQUFHLEVBQUU7WUFDTCxNQUFNLENBQUMsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzNCLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxFQUFFO2dCQUNWLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUM7YUFDdEI7aUJBQU07Z0JBQ0gsTUFBTSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsa0JBQWtCLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUMxRTtTQUNKO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDVCxDQUFDLENBQUM7QUFDRixNQUFNLEtBQUssR0FBRyxDQUFDLEdBQVEsRUFBRSxHQUFXLEVBQUUsRUFBRTtJQUN0QyxNQUFNLENBQUMsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzdCLElBQUksQ0FBQyxFQUFFO1FBQ0gsR0FBRyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEIsR0FBRyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDaEIsR0FBRyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDaEIsR0FBRyxDQUFDLElBQUksR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNuRSxHQUFHLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7UUFDN0MsR0FBRyxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO0tBQ25EO0FBQ0gsQ0FBQyxDQUFDO0FBQ0Y7Ozs7O0VBS0U7QUFDRixNQUFNLE9BQU8sR0FBRztJQW1DZCxZQUFZLEdBQVc7UUE5QmYsaUJBQVksR0FBYyxFQUFFLENBQUM7UUErQmpDLEtBQUssQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDckIsQ0FBQztJQXJCRDttRUFDK0Q7SUFDL0QsSUFBSSxXQUFXO1FBQ1osT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDO0lBQzVCLENBQUM7SUFDRCxJQUFJLFdBQVcsQ0FBQyxLQUFnQjtRQUM5QixJQUFJLENBQUMsWUFBWSxHQUFHLEtBQUssSUFBSSxFQUFFLENBQUM7SUFDbEMsQ0FBQztJQUNEOzs7O09BSUc7SUFDSCxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQWU7UUFDekIsSUFBSSxHQUFHLFlBQVksR0FBRyxFQUFFO1lBQ3RCLE9BQU8sR0FBRyxDQUFDO1NBQ1o7UUFDRCxPQUFPLElBQUksR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3RCLENBQUM7SUFJRDs7Ozs7T0FLRztJQUNILElBQUksVUFBVTtRQUNWLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQ3hCLENBQUM7SUFDRDs7Ozs7T0FLRztJQUNILElBQUksVUFBVTtRQUNWLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7SUFDekIsQ0FBQztJQUNEOzs7O09BSUc7SUFDSCxJQUFJLFNBQVM7UUFDVCxJQUFJLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLEdBQUcsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ3pFLE9BQU8sR0FBRyxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztTQUN0QztRQUNELE9BQU8sSUFBSSxDQUFDLElBQUksSUFBSSxFQUFFLENBQUM7SUFDM0IsQ0FBQztJQUNELElBQUksU0FBUyxDQUFDLFNBQWlCO1FBQzNCLE1BQU0sQ0FBQyxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDakMsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDVixJQUFJLENBQUMsSUFBSSxHQUFHLFNBQVMsQ0FBQztZQUN0QixJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQztTQUNqQjthQUFNO1lBQ0gsSUFBSSxDQUFDLElBQUksR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUNuQyxJQUFJLENBQUMsSUFBSSxHQUFHLFFBQVEsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDMUQ7SUFDTCxDQUFDO0lBQ0Q7Ozs7T0FJRztJQUNILElBQUksSUFBSTtRQUNKLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDekIsTUFBTSxXQUFXLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDN0MsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUMxRCxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQzlELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDcEQsT0FBTyxHQUFHLE1BQU0sR0FBRyxTQUFTLEdBQUcsSUFBSSxDQUFDLElBQUksR0FBRyxXQUFXLEdBQUcsUUFBUSxFQUFFLENBQUM7SUFDeEUsQ0FBQztJQUNELElBQUksSUFBSSxDQUFFLElBQUk7UUFDVixLQUFLLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3RCLENBQUM7SUFDRDs7Ozs7T0FLRztJQUNILElBQUksS0FBSztRQUNMLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxZQUFZLElBQUksRUFBRSxDQUFDO1FBQzVDLE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUM7YUFDMUIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ1QsTUFBTSxHQUFHLEdBQUcsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzdCLE9BQU8sR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxJQUFJLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsa0JBQWtCLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQztRQUN2RyxDQUFDLENBQUM7YUFDRCxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDbkIsQ0FBQztJQUNELElBQUksS0FBSyxDQUFFLEtBQUs7UUFDWixJQUFJLENBQUMsWUFBWSxHQUFHLEVBQUUsQ0FBQztRQUN2QixVQUFVLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxLQUFLLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBQ0QsUUFBUTtRQUNKLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQztJQUNyQixDQUFDOztBQWpITSxnQkFBWSxHQUFpQjtJQUNsQyxNQUFNLEVBQUUsRUFBRTtJQUNWLE9BQU8sRUFBRSxHQUFHO0NBQ2IsQ0FBQztBQStHSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gc2VlOiBodHRwczovL3Rvb2xzLmlldGYub3JnL2h0bWwvcmZjMzk4NlxuY29uc3QgcmVnZXhVcmkgPSAvXigoW2Etel1bYS16MC05Ky4tXSopOik/KFxcL1xcLygoWyEkJlxcXFwnKCkqLDs9YS16MC05Ll9+LV18JVswLTlhLWZdWzAtOWEtZl0pKikoXFw6KFswLTldKykpPyk/KChbXFwvISQmXFxcXCcoKSosOz06QGEtejAtOS5ffi1dfCVbMC05YS1mXVswLTlhLWZdKSopKFxcPyhbISQmXFxcXCcoKSosOz06QGEtejAtOS5fflxcLz8tXXwlWzAtOWEtZl1bMC05YS1mXSkqKT8oXFwjLiopPyQvaTtcblxuaW50ZXJmYWNlIFN0cmluZ01hcCB7XG4gIFtrZXk6IHN0cmluZ106IHN0cmluZ3xudWxsfHVuZGVmaW5lZDtcbn1cblxuaW50ZXJmYWNlIERlZmF1bHRQb3J0cyB7XG4gIFtrZXk6IHN0cmluZ106IG51bWJlcnx1bmRlZmluZWQ7XG59XG5cblxuY29uc3QgcGFyc2VRdWVyeSA9IChwYXJhbXM6IFN0cmluZ01hcCwgcmF3OiBzdHJpbmcpID0+IHtcbiAgcmF3XG4gICAgICAuc3BsaXQoJyYnKVxuICAgICAgLmZvckVhY2gob25lID0+IHtcbiAgICAgICAgICBpZiAob25lKSB7XG4gICAgICAgICAgICAgIGNvbnN0IGkgPSBvbmUuaW5kZXhPZignPScpO1xuICAgICAgICAgICAgICBpZiAoLTEgPT09IGkpIHtcbiAgICAgICAgICAgICAgICAgIHBhcmFtc1tvbmVdID0gbnVsbDtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgIHBhcmFtc1tvbmUuc3Vic3RyaW5nKDAsIGkpXSA9IGRlY29kZVVSSUNvbXBvbmVudChvbmUuc3Vic3RyaW5nKGkgKyAxKSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICB9KTtcbn07XG5jb25zdCBwYXJzZSA9ICh1cmk6IFVyaSwgcmF3OiBzdHJpbmcpID0+IHtcbiAgY29uc3QgbSA9IHJlZ2V4VXJpLmV4ZWMocmF3KTtcbiAgaWYgKG0pIHtcbiAgICAgIHVyaS5zY2hlbWUgPSBtWzJdO1xuICAgICAgdXJpLmhvc3QgPSBtWzRdO1xuICAgICAgdXJpLnBhdGggPSBtWzhdO1xuICAgICAgdXJpLnBvcnQgPSBwYXJzZUludChtWzddLCAxMCkgfHwgVXJpLmRlZmF1bHRQb3J0c1t1cmkuc2NoZW1lXSB8fCAwO1xuICAgICAgdXJpLnF1ZXJ5ID0gKG1bMTBdICYmIG1bMTBdLnN1YnN0cigxKSB8fCAnJyk7XG4gICAgICB1cmkuZnJhZ21lbnQgPSAobVsxMl0gJiYgbVsxMl0uc3Vic3RyKDEpIHx8ICcnKTtcbiAgfVxufTtcbi8qKlxuKiBTaW1wbGUgYW5kIHN0cmFpZ2h0Zm9yd2FyZCBVcmkgd3JhcHBlci5cbipcbiogQGNsYXNzIGRvcGUuVXJpXG4qIEBwYXJhbSB7U3RyaW5nfSByYXcgLSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIFVyaS5cbiovXG5leHBvcnQgY2xhc3MgVXJpIHtcbiAgc3RhdGljIGRlZmF1bHRQb3J0czogRGVmYXVsdFBvcnRzID0ge1xuICAgICdodHRwJzogODAsXG4gICAgJ2h0dHBzJzogNDQzXG4gIH07XG4gIHByaXZhdGUgX3F1ZXJ5UGFyYW1zOiBTdHJpbmdNYXAgPSB7fTtcbiAgLyoqIEdldHMgb3Igc2V0cyBzY2hlbWUgb2YgdGhlIFVyaS4gKi9cbiAgc2NoZW1lPzogc3RyaW5nO1xuICAvKiogR2V0cyBvciBzZXRzIGhvc3RuYW1lIG9mIHRoZSBVcmkuICovXG4gIGhvc3Q/OiBzdHJpbmc7XG4gIC8qKiBHZXRzIG9yIHNldHMgcGF0aCBjb21wb25lbnQgb2YgdGhlIFVyaS4gKi9cbiAgcGF0aCE6IHN0cmluZztcbiAgLyoqIEdldHMgb3Igc2V0cyBwb3J0IG9mIHRoZSBVcmkuICovXG4gIHBvcnQ/OiBudW1iZXI7XG4gIC8qKiBHZXRzIG9yIHNldHMgZnJhZ21lbnQgb2YgdGhlIFVyaS4gKi9cbiAgZnJhZ21lbnQ/OiBzdHJpbmc7XG4gIC8qKiBHZXRzIG9yIHNldHMgcXVlcnkgY29tcG9uZW50IG9mIHRoZSBVcmkgYXMgb2JqZWN0LiBBbGxvd3MgYWNjZXNzaW5nIGFuZFxuICAgKiBtYW5pcHVsYXRpbmcgaW5kaXZpZHVhbCBhcmd1bWVudHMgd2l0aGluIHF1ZXJ5IGNvbXBvbmVudC4gKi9cbiAgZ2V0IHF1ZXJ5UGFyYW1zKCkge1xuICAgICByZXR1cm4gdGhpcy5fcXVlcnlQYXJhbXM7XG4gIH1cbiAgc2V0IHF1ZXJ5UGFyYW1zKHZhbHVlOiBTdHJpbmdNYXApIHtcbiAgICB0aGlzLl9xdWVyeVBhcmFtcyA9IHZhbHVlIHx8IHt9O1xuICB9XG4gIC8qKlxuICAgKiBDcmVhdGVzIHtAbGluayBVcml9IGZvcm0gYW4gYXJndW1lbnQuXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfFVyaX0gdXJpIC0gU291cmNlIHVyaS5cbiAgICovXG4gIHN0YXRpYyBmcm9tKHVyaTogc3RyaW5nfFVyaSkge1xuICAgIGlmICh1cmkgaW5zdGFuY2VvZiBVcmkpIHtcbiAgICAgIHJldHVybiB1cmk7XG4gICAgfVxuICAgIHJldHVybiBuZXcgVXJpKHVyaSk7XG4gIH1cbiAgY29uc3RydWN0b3IocmF3OiBzdHJpbmcpIHtcbiAgICAgIHBhcnNlKHRoaXMsIHJhdyk7XG4gIH1cbiAgLyoqXG4gICAqIElzIF90cnVlXyBpZiB0aGUgd3JhcHBlciBVcmkgaXMgcmVsYXRpdmUuXG4gICAqXG4gICAqIEB0eXBlIHtCb29sZWFufVxuICAgKiBAcmVhZG9ubHlcbiAgICovXG4gIGdldCBpc1JlbGF0aXZlICgpIHtcbiAgICAgIHJldHVybiAhdGhpcy5zY2hlbWU7XG4gIH1cbiAgLyoqXG4gICAqIElzIF90cnVlXyBpZiB0aGUgd3JhcHBlciBVcmkgaXMgYWJzb2x1dGUuXG4gICAqXG4gICAqIEB0eXBlIHtCb29sZWFufVxuICAgKiBAcmVhZG9ubHlcbiAgICovXG4gIGdldCBpc0Fic29sdXRlICgpIHtcbiAgICAgIHJldHVybiAhIXRoaXMuc2NoZW1lO1xuICB9XG4gIC8qKlxuICAgKiBHZXRzIG9yIHNldHMgYXV0aG9yaXR5IG9mIHRoZSBVcmkgKGkuZS4gaG9zdG5hbWUgYW5kIHBvcnQgaWYgbm9uIHN0YW5kYXJkKS5cbiAgICpcbiAgICogQHR5cGUge1N0cmluZ31cbiAgICovXG4gIGdldCBhdXRob3JpdHkgKCkge1xuICAgICAgaWYgKHRoaXMucG9ydCAmJiB0aGlzLnNjaGVtZSAmJiB0aGlzLnBvcnQgIT09IFVyaS5kZWZhdWx0UG9ydHNbdGhpcy5zY2hlbWVdKSB7XG4gICAgICAgICAgcmV0dXJuIGAke3RoaXMuaG9zdH06JHt0aGlzLnBvcnR9YDtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0aGlzLmhvc3QgfHwgJyc7XG4gIH1cbiAgc2V0IGF1dGhvcml0eShhdXRob3JpdHk6IHN0cmluZykge1xuICAgICAgY29uc3QgaSA9IGF1dGhvcml0eS5pbmRleE9mKCc6Jyk7XG4gICAgICBpZiAoLTEgPT09IGkpIHtcbiAgICAgICAgICB0aGlzLmhvc3QgPSBhdXRob3JpdHk7XG4gICAgICAgICAgdGhpcy5wb3J0ID0gMDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5ob3N0ID0gYXV0aG9yaXR5LnN1YnN0cigwLCBpKTtcbiAgICAgICAgICB0aGlzLnBvcnQgPSBwYXJzZUludChhdXRob3JpdHkuc3Vic3RyKGkgKyAxKSwgMTApIHx8IDA7XG4gICAgICB9XG4gIH1cbiAgLyoqXG4gICAqIEdldHMgb3Igc2V0cyB0aGUgd3JhcHBlZCBVcmkuXG4gICAqXG4gICAqIEB0eXBlIHtTdHJpbmd9XG4gICAqL1xuICBnZXQgaHJlZiAoKSB7XG4gICAgICBjb25zdCBxdWVyeSA9IHRoaXMucXVlcnk7XG4gICAgICBjb25zdCBxdWVyeVN0cmluZyA9IHF1ZXJ5ID8gYD8ke3F1ZXJ5fWAgOiAnJztcbiAgICAgIGNvbnN0IGZyYWdtZW50ID0gdGhpcy5mcmFnbWVudCA/IGAjJHt0aGlzLmZyYWdtZW50fWAgOiAnJztcbiAgICAgIGNvbnN0IGF1dGhvcml0eSA9IHRoaXMuYXV0aG9yaXR5ID8gYC8vJHt0aGlzLmF1dGhvcml0eX1gIDogJyc7XG4gICAgICBjb25zdCBzY2hlbWUgPSB0aGlzLnNjaGVtZSA/IGAke3RoaXMuc2NoZW1lfTpgIDogJyc7XG4gICAgICByZXR1cm4gYCR7c2NoZW1lfSR7YXV0aG9yaXR5fSR7dGhpcy5wYXRofSR7cXVlcnlTdHJpbmd9JHtmcmFnbWVudH1gO1xuICB9XG4gIHNldCBocmVmIChocmVmKSB7XG4gICAgICBwYXJzZSh0aGlzLCBocmVmKTtcbiAgfVxuICAvKipcbiAgICogR2V0cyBvciBzZXRzIHF1ZXJ5IGNvbXBvbmVudCBvZiB0aGUgVXJpLiBUbyBhY2Nlc3Mgb3IgbWFuaXB1bGF0ZSBpbmRpdmlkdWFsIHF1ZXJ5IGFyZ3VtZW50cyB1c2VcbiAgICoge0BsaW5rIGRvcGUuVXJpI3F1ZXJ5UGFyYW1zfS5cbiAgICpcbiAgICogQHR5cGUge1N0cmluZ31cbiAgICovXG4gIGdldCBxdWVyeSAoKSB7XG4gICAgICBjb25zdCBxdWVyeVBhcmFtcyA9IHRoaXMuX3F1ZXJ5UGFyYW1zIHx8IHt9O1xuICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHF1ZXJ5UGFyYW1zKVxuICAgICAgICAgIC5tYXAoa2V5ID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHZhbCA9IHF1ZXJ5UGFyYW1zW2tleV07XG4gICAgICAgICAgICByZXR1cm4gdmFsID8gYCR7ZW5jb2RlVVJJQ29tcG9uZW50KGtleSl9PSR7ZW5jb2RlVVJJQ29tcG9uZW50KHZhbCl9YCA6IGAke2VuY29kZVVSSUNvbXBvbmVudChrZXkpfT1gO1xuICAgICAgICAgIH0pXG4gICAgICAgICAgLmpvaW4oJyYnKTtcbiAgfVxuICBzZXQgcXVlcnkgKHF1ZXJ5KSB7XG4gICAgICB0aGlzLl9xdWVyeVBhcmFtcyA9IHt9O1xuICAgICAgcGFyc2VRdWVyeSh0aGlzLl9xdWVyeVBhcmFtcywgcXVlcnkpO1xuICB9XG4gIHRvU3RyaW5nICgpIHtcbiAgICAgIHJldHVybiB0aGlzLmhyZWY7XG4gIH1cbn07Il19