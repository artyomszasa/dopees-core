// see: https://tools.ietf.org/html/rfc3986
// tslint:disable-next-line:max-line-length
const regexUri = /^(([a-z][a-z0-9+.-]*):)?(\/\/(([!$&\\'()*,;=a-z0-9._~-]|%[0-9a-f][0-9a-f])*)(\:([0-9]+))?)?(([\/!$&\\'()*,;=:@a-z0-9._~-]|%[0-9a-f][0-9a-f])*)(\?([!$&\\'()*,;=:@a-z0-9._~\/?-]|%[0-9a-f][0-9a-f])*)?(\#.*)?$/i;
const parseQuery = (params, raw) => {
    raw
        .split('&')
        .forEach((one) => {
        if (one) {
            const i = one.indexOf('=');
            if (-1 === i) {
                params[one] = null;
            }
            else {
                params[one.substring(0, i)] = decodeURIComponent(one.substring(i + 1));
            }
        }
    });
};
const parse = (uri, raw) => {
    const m = regexUri.exec(raw);
    if (m) {
        uri.scheme = m[2];
        uri.host = m[4];
        uri.path = m[8];
        uri.port = parseInt(m[7], 10) || Uri.defaultPorts[uri.scheme] || 0;
        uri.query = (m[10] && m[10].substr(1) || '');
        uri.fragment = (m[12] && m[12].substr(1) || '');
    }
};
/**
 * Simple and straightforward Uri wrapper.
 *
 * @class dope.Uri
 * @param {String} raw - string representation of the Uri.
 */
export class Uri {
    constructor(raw) {
        this._queryParams = {};
        parse(this, raw);
    }
    /**
     * Gets or sets query component of the Uri as object. Allows accessing and
     * manipulating individual arguments within query component.
     */
    get queryParams() {
        return this._queryParams;
    }
    set queryParams(value) {
        this._queryParams = value || {};
    }
    /**
     * Creates {@link Uri} form an argument.
     *
     * @param {string|Uri} uri - Source uri.
     */
    static from(uri) {
        if (uri instanceof Uri) {
            return uri;
        }
        return new Uri(uri);
    }
    /**
     * Is _true_ if the wrapper Uri is relative.
     *
     * @type {Boolean}
     * @readonly
     */
    get isRelative() {
        return !this.scheme;
    }
    /**
     * Is _true_ if the wrapper Uri is absolute.
     *
     * @type {Boolean}
     * @readonly
     */
    get isAbsolute() {
        return !!this.scheme;
    }
    /**
     * Gets or sets authority of the Uri (i.e. hostname and port if non standard).
     *
     * @type {String}
     */
    get authority() {
        if (this.port && this.scheme && this.port !== Uri.defaultPorts[this.scheme]) {
            return `${this.host}:${this.port}`;
        }
        return this.host || '';
    }
    set authority(authority) {
        const i = authority.indexOf(':');
        if (-1 === i) {
            this.host = authority;
            this.port = 0;
        }
        else {
            this.host = authority.substr(0, i);
            this.port = parseInt(authority.substr(i + 1), 10) || 0;
        }
    }
    /**
     * Gets or sets the wrapped Uri.
     *
     * @type {String}
     */
    get href() {
        const query = this.query;
        const queryString = query ? `?${query}` : '';
        const fragment = this.fragment ? `#${this.fragment}` : '';
        const authority = this.authority ? `//${this.authority}` : '';
        const scheme = this.scheme ? `${this.scheme}:` : '';
        return `${scheme}${authority}${this.path}${queryString}${fragment}`;
    }
    set href(href) {
        parse(this, href);
    }
    /**
     * Gets or sets query component of the Uri. To access or manipulate individual query arguments use
     * {@link dope.Uri#queryParams}.
     *
     * @type {String}
     */
    get query() {
        const queryParams = this._queryParams || {};
        return Object.keys(queryParams)
            .map((key) => {
            const val = queryParams[key];
            return val ? `${encodeURIComponent(key)}=${encodeURIComponent(val)}` : `${encodeURIComponent(key)}=`;
        })
            .join('&');
    }
    set query(query) {
        this._queryParams = {};
        parseQuery(this._queryParams, query);
    }
    toString() {
        return this.href;
    }
}
Uri.defaultPorts = {
    http: 80,
    https: 443
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXJpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3VyaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSwyQ0FBMkM7QUFDM0MsMkNBQTJDO0FBQzNDLE1BQU0sUUFBUSxHQUFHLGdOQUFnTixDQUFDO0FBVWxPLE1BQU0sVUFBVSxHQUFHLENBQUMsTUFBaUIsRUFBRSxHQUFXLEVBQUUsRUFBRTtJQUNwRCxHQUFHO1NBQ0UsS0FBSyxDQUFDLEdBQUcsQ0FBQztTQUNWLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1FBQ2IsSUFBSSxHQUFHLEVBQUU7WUFDTCxNQUFNLENBQUMsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzNCLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxFQUFFO2dCQUNWLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUM7YUFDdEI7aUJBQU07Z0JBQ0gsTUFBTSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsa0JBQWtCLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUMxRTtTQUNKO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDVCxDQUFDLENBQUM7QUFDRixNQUFNLEtBQUssR0FBRyxDQUFDLEdBQVEsRUFBRSxHQUFXLEVBQUUsRUFBRTtJQUN0QyxNQUFNLENBQUMsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzdCLElBQUksQ0FBQyxFQUFFO1FBQ0gsR0FBRyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEIsR0FBRyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDaEIsR0FBRyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDaEIs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QUUsQ0FBQztRQUN2QixVQUFVLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxLQUFLLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBQ0QsUUFBUTtRQUNOLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQztJQUNuQixDQUFDOztBQW5ITSxnQkFBWSxHQUFpQjtJQUNsQyxJQUFJLEVBQUUsRUFBRTtJQUNSLEtBQUssRUFBRSxHQUFHO0NBQ1gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHNlZTogaHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzM5ODZcbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbmNvbnN0IHJlZ2V4VXJpID0gL14oKFthLXpdW2EtejAtOSsuLV0qKTopPyhcXC9cXC8oKFshJCZcXFxcJygpKiw7PWEtejAtOS5ffi1dfCVbMC05YS1mXVswLTlhLWZdKSopKFxcOihbMC05XSspKT8pPygoW1xcLyEkJlxcXFwnKCkqLDs9OkBhLXowLTkuX34tXXwlWzAtOWEtZl1bMC05YS1mXSkqKShcXD8oWyEkJlxcXFwnKCkqLDs9OkBhLXowLTkuX35cXC8/LV18JVswLTlhLWZdWzAtOWEtZl0pKik/KFxcIy4qKT8kL2k7XG5cbmludGVyZmFjZSBTdHJpbmdNYXAge1xuICBba2V5OiBzdHJpbmddOiBzdHJpbmd8bnVsbHx1bmRlZmluZWQ7XG59XG5cbmludGVyZmFjZSBEZWZhdWx0UG9ydHMge1xuICBba2V5OiBzdHJpbmddOiBudW1iZXJ8dW5kZWZpbmVkO1xufVxuXG5jb25zdCBwYXJzZVF1ZXJ5ID0gKHBhcmFtczogU3RyaW5nTWFwLCByYXc6IHN0cmluZykgPT4ge1xuICByYXdcbiAgICAgIC5zcGxpdCgnJicpXG4gICAgICAuZm9yRWFjaCgob25lKSA9PiB7XG4gICAgICAgICAgaWYgKG9uZSkge1xuICAgICAgICAgICAgICBjb25zdCBpID0gb25lLmluZGV4T2YoJz0nKTtcbiAgICAgICAgICAgICAgaWYgKC0xID09PSBpKSB7XG4gICAgICAgICAgICAgICAgICBwYXJhbXNbb25lXSA9IG51bGw7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICBwYXJhbXNbb25lLnN1YnN0cmluZygwLCBpKV0gPSBkZWNvZGVVUklDb21wb25lbnQob25lLnN1YnN0cmluZyhpICsgMSkpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgfSk7XG59O1xuY29uc3QgcGFyc2UgPSAodXJpOiBVcmksIHJhdzogc3RyaW5nKSA9PiB7XG4gIGNvbnN0IG0gPSByZWdleFVyaS5leGVjKHJhdyk7XG4gIGlmIChtKSB7XG4gICAgICB1cmkuc2NoZW1lID0gbVsyXTtcbiAgICAgIHVyaS5ob3N0ID0gbVs0XTtcbiAgICAgIHVyaS5wYXRoID0gbVs4XTtcbiAgICAgIHVyaS5wb3J0ID0gcGFyc2VJbnQobVs3XSwgMTApIHx8IFVyaS5kZWZhdWx0UG9ydHNbdXJpLnNjaGVtZV0gfHwgMDtcbiAgICAgIHVyaS5xdWVyeSA9IChtWzEwXSAmJiBtWzEwXS5zdWJzdHIoMSkgfHwgJycpO1xuICAgICAgdXJpLmZyYWdtZW50ID0gKG1bMTJdICYmIG1bMTJdLnN1YnN0cigxKSB8fCAnJyk7XG4gIH1cbn07XG5cbi8qKlxuICogU2ltcGxlIGFuZCBzdHJhaWdodGZvcndhcmQgVXJpIHdyYXBwZXIuXG4gKlxuICogQGNsYXNzIGRvcGUuVXJpXG4gKiBAcGFyYW0ge1N0cmluZ30gcmF3IC0gc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBVcmkuXG4gKi9cbmV4cG9ydCBjbGFzcyBVcmkge1xuICBzdGF0aWMgZGVmYXVsdFBvcnRzOiBEZWZhdWx0UG9ydHMgPSB7XG4gICAgaHR0cDogODAsXG4gICAgaHR0cHM6IDQ0M1xuICB9O1xuICBwcml2YXRlIF9xdWVyeVBhcmFtczogU3RyaW5nTWFwID0ge307XG4gIC8qKiBHZXRzIG9yIHNldHMgc2NoZW1lIG9mIHRoZSBVcmkuICovXG4gIHNjaGVtZT86IHN0cmluZztcbiAgLyoqIEdldHMgb3Igc2V0cyBob3N0bmFtZSBvZiB0aGUgVXJpLiAqL1xuICBob3N0Pzogc3RyaW5nO1xuICAvKiogR2V0cyBvciBzZXRzIHBhdGggY29tcG9uZW50IG9mIHRoZSBVcmkuICovXG4gIHBhdGghOiBzdHJpbmc7XG4gIC8qKiBHZXRzIG9yIHNldHMgcG9ydCBvZiB0aGUgVXJpLiAqL1xuICBwb3J0PzogbnVtYmVyO1xuICAvKiogR2V0cyBvciBzZXRzIGZyYWdtZW50IG9mIHRoZSBVcmkuICovXG4gIGZyYWdtZW50Pzogc3RyaW5nO1xuICAvKipcbiAgICogR2V0cyBvciBzZXRzIHF1ZXJ5IGNvbXBvbmVudCBvZiB0aGUgVXJpIGFzIG9iamVjdC4gQWxsb3dzIGFjY2Vzc2luZyBhbmRcbiAgICogbWFuaXB1bGF0aW5nIGluZGl2aWR1YWwgYXJndW1lbnRzIHdpdGhpbiBxdWVyeSBjb21wb25lbnQuXG4gICAqL1xuICBnZXQgcXVlcnlQYXJhbXMoKSB7XG4gICAgIHJldHVybiB0aGlzLl9xdWVyeVBhcmFtcztcbiAgfVxuICBzZXQgcXVlcnlQYXJhbXModmFsdWU6IFN0cmluZ01hcCkge1xuICAgIHRoaXMuX3F1ZXJ5UGFyYW1zID0gdmFsdWUgfHwge307XG4gIH1cbiAgLyoqXG4gICAqIENyZWF0ZXMge0BsaW5rIFVyaX0gZm9ybSBhbiBhcmd1bWVudC5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd8VXJpfSB1cmkgLSBTb3VyY2UgdXJpLlxuICAgKi9cbiAgc3RhdGljIGZyb20odXJpOiBzdHJpbmd8VXJpKSB7XG4gICAgaWYgKHVyaSBpbnN0YW5jZW9mIFVyaSkge1xuICAgICAgcmV0dXJuIHVyaTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBVcmkodXJpKTtcbiAgfVxuICBjb25zdHJ1Y3RvcihyYXc6IHN0cmluZykge1xuICAgICAgcGFyc2UodGhpcywgcmF3KTtcbiAgfVxuICAvKipcbiAgICogSXMgX3RydWVfIGlmIHRoZSB3cmFwcGVyIFVyaSBpcyByZWxhdGl2ZS5cbiAgICpcbiAgICogQHR5cGUge0Jvb2xlYW59XG4gICAqIEByZWFkb25seVxuICAgKi9cbiAgZ2V0IGlzUmVsYXRpdmUoKSB7XG4gICAgICByZXR1cm4gIXRoaXMuc2NoZW1lO1xuICB9XG4gIC8qKlxuICAgKiBJcyBfdHJ1ZV8gaWYgdGhlIHdyYXBwZXIgVXJpIGlzIGFic29sdXRlLlxuICAgKlxuICAgKiBAdHlwZSB7Qm9vbGVhbn1cbiAgICogQHJlYWRvbmx5XG4gICAqL1xuICBnZXQgaXNBYnNvbHV0ZSgpIHtcbiAgICAgIHJldHVybiAhIXRoaXMuc2NoZW1lO1xuICB9XG4gIC8qKlxuICAgKiBHZXRzIG9yIHNldHMgYXV0aG9yaXR5IG9mIHRoZSBVcmkgKGkuZS4gaG9zdG5hbWUgYW5kIHBvcnQgaWYgbm9uIHN0YW5kYXJkKS5cbiAgICpcbiAgICogQHR5cGUge1N0cmluZ31cbiAgICovXG4gIGdldCBhdXRob3JpdHkoKSB7XG4gICAgaWYgKHRoaXMucG9ydCAmJiB0aGlzLnNjaGVtZSAmJiB0aGlzLnBvcnQgIT09IFVyaS5kZWZhdWx0UG9ydHNbdGhpcy5zY2hlbWVdKSB7XG4gICAgICByZXR1cm4gYCR7dGhpcy5ob3N0fToke3RoaXMucG9ydH1gO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5ob3N0IHx8ICcnO1xuICB9XG4gIHNldCBhdXRob3JpdHkoYXV0aG9yaXR5OiBzdHJpbmcpIHtcbiAgICBjb25zdCBpID0gYXV0aG9yaXR5LmluZGV4T2YoJzonKTtcbiAgICBpZiAoLTEgPT09IGkpIHtcbiAgICAgIHRoaXMuaG9zdCA9IGF1dGhvcml0eTtcbiAgICAgIHRoaXMucG9ydCA9IDA7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuaG9zdCA9IGF1dGhvcml0eS5zdWJzdHIoMCwgaSk7XG4gICAgICB0aGlzLnBvcnQgPSBwYXJzZUludChhdXRob3JpdHkuc3Vic3RyKGkgKyAxKSwgMTApIHx8IDA7XG4gICAgfVxuICB9XG4gIC8qKlxuICAgKiBHZXRzIG9yIHNldHMgdGhlIHdyYXBwZWQgVXJpLlxuICAgKlxuICAgKiBAdHlwZSB7U3RyaW5nfVxuICAgKi9cbiAgZ2V0IGhyZWYoKSB7XG4gICAgY29uc3QgcXVlcnkgPSB0aGlzLnF1ZXJ5O1xuICAgIGNvbnN0IHF1ZXJ5U3RyaW5nID0gcXVlcnkgPyBgPyR7cXVlcnl9YCA6ICcnO1xuICAgIGNvbnN0IGZyYWdtZW50ID0gdGhpcy5mcmFnbWVudCA/IGAjJHt0aGlzLmZyYWdtZW50fWAgOiAnJztcbiAgICBjb25zdCBhdXRob3JpdHkgPSB0aGlzLmF1dGhvcml0eSA/IGAvLyR7dGhpcy5hdXRob3JpdHl9YCA6ICcnO1xuICAgIGNvbnN0IHNjaGVtZSA9IHRoaXMuc2NoZW1lID8gYCR7dGhpcy5zY2hlbWV9OmAgOiAnJztcbiAgICByZXR1cm4gYCR7c2NoZW1lfSR7YXV0aG9yaXR5fSR7dGhpcy5wYXRofSR7cXVlcnlTdHJpbmd9JHtmcmFnbWVudH1gO1xuICB9XG4gIHNldCBocmVmKGhyZWYpIHtcbiAgICBwYXJzZSh0aGlzLCBocmVmKTtcbiAgfVxuICAvKipcbiAgICogR2V0cyBvciBzZXRzIHF1ZXJ5IGNvbXBvbmVudCBvZiB0aGUgVXJpLiBUbyBhY2Nlc3Mgb3IgbWFuaXB1bGF0ZSBpbmRpdmlkdWFsIHF1ZXJ5IGFyZ3VtZW50cyB1c2VcbiAgICoge0BsaW5rIGRvcGUuVXJpI3F1ZXJ5UGFyYW1zfS5cbiAgICpcbiAgICogQHR5cGUge1N0cmluZ31cbiAgICovXG4gIGdldCBxdWVyeSgpIHtcbiAgICAgIGNvbnN0IHF1ZXJ5UGFyYW1zID0gdGhpcy5fcXVlcnlQYXJhbXMgfHwge307XG4gICAgICByZXR1cm4gT2JqZWN0LmtleXMocXVlcnlQYXJhbXMpXG4gICAgICAgIC5tYXAoKGtleSkgPT4ge1xuICAgICAgICAgIGNvbnN0IHZhbCA9IHF1ZXJ5UGFyYW1zW2tleV07XG4gICAgICAgICAgcmV0dXJuIHZhbCA/IGAke2VuY29kZVVSSUNvbXBvbmVudChrZXkpfT0ke2VuY29kZVVSSUNvbXBvbmVudCh2YWwpfWAgOiBgJHtlbmNvZGVVUklDb21wb25lbnQoa2V5KX09YDtcbiAgICAgICAgfSlcbiAgICAgICAgLmpvaW4oJyYnKTtcbiAgfVxuICBzZXQgcXVlcnkocXVlcnkpIHtcbiAgICB0aGlzLl9xdWVyeVBhcmFtcyA9IHt9O1xuICAgIHBhcnNlUXVlcnkodGhpcy5fcXVlcnlQYXJhbXMsIHF1ZXJ5KTtcbiAgfVxuICB0b1N0cmluZygpIHtcbiAgICByZXR1cm4gdGhpcy5ocmVmO1xuICB9XG59XG4iXX0=