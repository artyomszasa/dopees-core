const decorators = [];
const doFetch = (decorators, uri, init) => {
    let opts = init || {};
    for (const decorator of decorators) {
        const newOpts = decorator.decorate(uri, opts);
        if (newOpts) {
            opts = newOpts;
        }
    }
    return window.fetch(uri, opts);
};
export const decoratedFetch = Object.assign(Object.defineProperty((uri, init) => doFetch(decorators, uri, init), 'decorators', {
    get() { return decorators; }
}), {
    native: window.fetch.bind(window),
    include: (...input) => {
        const ds = [];
        for (const key of input) {
            if ('string' === typeof key) {
                const d = decorators.find(x => x.name === key);
                if (!d) {
                    throw new Error('invalid or missing decorator: ' + key);
                }
                ds.push(d);
            }
            else {
                ds.push(key);
            }
        }
        return (uri, init) => doFetch(ds, uri, init);
    },
    exclude: (...input) => {
        const ds = decorators.slice(0);
        for (const key of input) {
            if ('string' === typeof key) {
                const index = ds.findIndex(x => x.name === key);
                if (-1 !== index) {
                    ds.splice(index, 1);
                }
            }
            else {
                const index = ds.findIndex(x => x === key);
                if (-1 !== index) {
                    ds.splice(index, 1);
                }
            }
        }
        return (uri, init) => doFetch(ds, uri, init);
    }
});
const defaultErrors = {
    400: 'Bad request',
    500: 'Server error'
};
export class HttpError extends Error {
    constructor(response, message) {
        super(message ? message : defaultErrors[response.status] || `Unexpected error while fetching ${response.url}`);
        const that = this; // iOS workaround...
        Object.setPrototypeOf(that, HttpError.prototype);
        if ('function' === typeof Error.captureStackTrace) {
            Error.captureStackTrace(that, that.constructor);
        }
        this.response = response;
    }
}
export async function httpGet(uri) {
    const response = await decoratedFetch(uri, { method: 'GET' });
    if (response.ok) {
        return response;
    }
    const message = response.headers.get('X-Message');
    if (message) {
        throw new HttpError(response, message);
    }
    throw new HttpError(response);
}
export async function httpGetJson(uri) {
    const response = await httpGet(uri);
    return (await response.json());
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmV0Y2guanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZmV0Y2gudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBbUJBLE1BQU0sVUFBVSxHQUFxQixFQUFFLENBQUM7QUFFeEMsTUFBTSxPQUFPLEdBQUcsQ0FBQyxVQUE0QixFQUFFLEdBQVcsRUFBRSxJQUEwQixFQUFFLEVBQUU7SUFDeEYsSUFBSSxJQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUN0QixLQUFLLE1BQU0sU0FBUyxJQUFJLFVBQVUsRUFBRTtRQUNsQyxNQUFNLE9BQU8sR0FBRyxTQUFTLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUM5QyxJQUFJLE9BQU8sRUFBRTtZQUNYLElBQUksR0FBRyxPQUFPLENBQUM7U0FDaEI7S0FDRjtJQUNELE9BQU8sTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDakMsQ0FBQyxDQUFDO0FBT0YsTUFBTSxDQUFDLE1BQU0sY0FBYyxHQUFtQixNQUFNLENBQUMsTUFBTSxDQUNoRCxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUMsR0FBVyxFQUFFLElBQTBCLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLFlBQVksRUFBRTtJQUN4SCxHQUFHLEtBQUssT0FBTyxVQUFVLENBQUEsQ0FBQyxDQUFDO0NBQzVCLENBQUMsRUFBRTtJQUNGLE1BQU0sRUFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7SUFDakMsT0FBTyxFQUFFLENBQUMsR0FBRyxLQUFnQyxFQUFFLEVBQUU7UUFDL0MsTUFBTSxFQUFFLEdBQXFCLEVBQUUsQ0FBQztRQUNoQyxLQUFLLE1BQU0sR0FBRyxJQUFJLEtBQUssRUFBRTtZQUN2QixJQUFJLFFBQVEsS0FBSyxPQUFPLEdBQUcsRUFBRTtnQkFDM0IsTUFBTSxD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QUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ2xELElBQUksT0FBTyxFQUFFO1FBQ1gsTUFBTSxJQUFJLFNBQVMsQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7S0FDeEM7SUFDRCxNQUFNLElBQUksU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ2hDLENBQUM7QUFFRCxNQUFNLENBQUMsS0FBSyxVQUFVLFdBQVcsQ0FBSSxHQUFXO0lBQzlDLE1BQU0sUUFBUSxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3BDLE9BQVUsQ0FBQyxNQUFNLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO0FBQ3BDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJcbmV4cG9ydCBpbnRlcmZhY2UgQW55UHJvcCB7XG4gIFtrZXk6IHN0cmluZ106IGFueVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIEZldGNoRGVjb3JhdG9yIHtcbiAgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuICBkZWNvcmF0ZSh1cmk6IHN0cmluZywgaW5pdDogUmVxdWVzdEluaXQmQW55UHJvcCk6IFJlcXVlc3RJbml0JkFueVByb3A7XG59XG5cblxuZXhwb3J0IGludGVyZmFjZSBEZWNvcmF0ZWRGZXRjaCB7XG4gICh1cmk6IHN0cmluZywgaW5pdDogUmVxdWVzdEluaXQmQW55UHJvcCk6IFByb21pc2U8UmVzcG9uc2U+O1xuICByZWFkb25seSBkZWNvcmF0b3JzOiBGZXRjaERlY29yYXRvcltdO1xuICBuYXRpdmUodXJpOiBzdHJpbmcsIGluaXQ6IFJlcXVlc3RJbml0KTogUHJvbWlzZTxSZXNwb25zZT47XG4gIGluY2x1ZGUoLi4uZGVjb3JhdG9yczogKHN0cmluZ3xGZXRjaERlY29yYXRvcilbXSk6ICh1cmk6IHN0cmluZywgaW5pdDogUmVxdWVzdEluaXQmQW55UHJvcCkgPT4gUHJvbWlzZTxSZXNwb25zZT47XG4gIGV4Y2x1ZGUoLi4uZGVjb3JhdG9yczogKHN0cmluZ3xGZXRjaERlY29yYXRvcilbXSk6ICh1cmk6IHN0cmluZywgaW5pdDogUmVxdWVzdEluaXQmQW55UHJvcCkgPT4gUHJvbWlzZTxSZXNwb25zZT47XG59XG5cbmNvbnN0IGRlY29yYXRvcnM6IEZldGNoRGVjb3JhdG9yW10gPSBbXTtcblxuY29uc3QgZG9GZXRjaCA9IChkZWNvcmF0b3JzOiBGZXRjaERlY29yYXRvcltdLCB1cmk6IHN0cmluZywgaW5pdD86IFJlcXVlc3RJbml0JkFueVByb3ApID0+IHtcbiAgbGV0IG9wdHMgPSBpbml0IHx8IHt9O1xuICBmb3IgKGNvbnN0IGRlY29yYXRvciBvZiBkZWNvcmF0b3JzKSB7XG4gICAgY29uc3QgbmV3T3B0cyA9IGRlY29yYXRvci5kZWNvcmF0ZSh1cmksIG9wdHMpO1xuICAgIGlmIChuZXdPcHRzKSB7XG4gICAgICBvcHRzID0gbmV3T3B0cztcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHdpbmRvdy5mZXRjaCh1cmksIG9wdHMpO1xufTtcblxuaW50ZXJmYWNlIEluaXRpYWwge1xuICAodXJpOiBzdHJpbmcsIGluaXQ6IFJlcXVlc3RJbml0JkFueVByb3ApOiBQcm9taXNlPFJlc3BvbnNlPjtcbiAgcmVhZG9ubHkgZGVjb3JhdG9yczogRmV0Y2hEZWNvcmF0b3JbXVxufVxuXG5leHBvcnQgY29uc3QgZGVjb3JhdGVkRmV0Y2g6IERlY29yYXRlZEZldGNoID0gT2JqZWN0LmFzc2lnbihcbiAgPEluaXRpYWw+T2JqZWN0LmRlZmluZVByb3BlcnR5KCh1cmk6IHN0cmluZywgaW5pdD86IFJlcXVlc3RJbml0JkFueVByb3ApID0+IGRvRmV0Y2goZGVjb3JhdG9ycywgdXJpLCBpbml0KSwgJ2RlY29yYXRvcnMnLCB7XG4gICAgZ2V0KCkgeyByZXR1cm4gZGVjb3JhdG9ycyB9XG4gIH0pLCB7XG4gICAgbmF0aXZlOiB3aW5kb3cuZmV0Y2guYmluZCh3aW5kb3cpLFxuICAgIGluY2x1ZGU6ICguLi5pbnB1dDogKHN0cmluZ3xGZXRjaERlY29yYXRvcilbXSkgPT4ge1xuICAgICAgY29uc3QgZHM6IEZldGNoRGVjb3JhdG9yW10gPSBbXTtcbiAgICAgIGZvciAoY29uc3Qga2V5IG9mIGlucHV0KSB7XG4gICAgICAgIGlmICgnc3RyaW5nJyA9PT0gdHlwZW9mIGtleSkge1xuICAgICAgICAgIGNvbnN0IGQgPSBkZWNvcmF0b3JzLmZpbmQoeCA9PiB4Lm5hbWUgPT09IGtleSk7XG4gICAgICAgICAgaWYgKCFkKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgb3IgbWlzc2luZyBkZWNvcmF0b3I6ICcgKyBrZXkpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBkcy5wdXNoKGQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGRzLnB1c2goa2V5KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuICh1cmk6IHN0cmluZywgaW5pdD86IFJlcXVlc3RJbml0JkFueVByb3ApID0+IGRvRmV0Y2goZHMsIHVyaSwgaW5pdCk7XG4gICAgfSxcbiAgICBleGNsdWRlOiAoLi4uaW5wdXQ6IChzdHJpbmd8RmV0Y2hEZWNvcmF0b3IpW10pID0+IHtcbiAgICAgIGNvbnN0IGRzOiBGZXRjaERlY29yYXRvcltdID0gZGVjb3JhdG9ycy5zbGljZSgwKTtcbiAgICAgIGZvciAoY29uc3Qga2V5IG9mIGlucHV0KSB7XG4gICAgICAgIGlmICgnc3RyaW5nJyA9PT0gdHlwZW9mIGtleSkge1xuICAgICAgICAgIGNvbnN0IGluZGV4ID0gZHMuZmluZEluZGV4KHggPT4geC5uYW1lID09PSBrZXkpO1xuICAgICAgICAgIGlmICgtMSAhPT0gaW5kZXgpIHtcbiAgICAgICAgICAgIGRzLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IGluZGV4ID0gZHMuZmluZEluZGV4KHggPT4geCA9PT0ga2V5KTtcbiAgICAgICAgICBpZiAoLTEgIT09IGluZGV4KSB7XG4gICAgICAgICAgICBkcy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuICh1cmk6IHN0cmluZywgaW5pdD86IFJlcXVlc3RJbml0JkFueVByb3ApID0+IGRvRmV0Y2goZHMsIHVyaSwgaW5pdCk7XG4gICAgfVxuICB9XG4pO1xuXG5jb25zdCBkZWZhdWx0RXJyb3JzOiB7IFtrZXk6IG51bWJlcl06IHN0cmluZ3x1bmRlZmluZWQgfSA9IHtcbiAgNDAwOiAnQmFkIHJlcXVlc3QnLFxuICA1MDA6ICdTZXJ2ZXIgZXJyb3InXG59XG5cbmV4cG9ydCBjbGFzcyBIdHRwRXJyb3IgZXh0ZW5kcyBFcnJvciB7XG4gIHJlc3BvbnNlOiBSZXNwb25zZTtcbiAgY29uc3RydWN0b3IocmVzcG9uc2U6IFJlc3BvbnNlLCBtZXNzYWdlPzogc3RyaW5nKSB7XG4gICAgc3VwZXIobWVzc2FnZSA/IG1lc3NhZ2UgOiBkZWZhdWx0RXJyb3JzW3Jlc3BvbnNlLnN0YXR1c10gfHwgYFVuZXhwZWN0ZWQgZXJyb3Igd2hpbGUgZmV0Y2hpbmcgJHtyZXNwb25zZS51cmx9YCk7XG4gICAgY29uc3QgdGhhdCA9IHRoaXM7IC8vIGlPUyB3b3JrYXJvdW5kLi4uXG4gICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKHRoYXQsIEh0dHBFcnJvci5wcm90b3R5cGUpO1xuICAgIGlmICgnZnVuY3Rpb24nID09PSB0eXBlb2YgKDxhbnk+RXJyb3IpLmNhcHR1cmVTdGFja1RyYWNlKSB7XG4gICAgICAoPGFueT5FcnJvcikuY2FwdHVyZVN0YWNrVHJhY2UodGhhdCwgdGhhdC5jb25zdHJ1Y3Rvcik7XG4gICAgfVxuICAgIHRoaXMucmVzcG9uc2UgPSByZXNwb25zZTtcbiAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaHR0cEdldCh1cmk6IHN0cmluZykge1xuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGRlY29yYXRlZEZldGNoKHVyaSwgeyBtZXRob2Q6ICdHRVQnIH0pO1xuICBpZiAocmVzcG9uc2Uub2spIHtcbiAgICByZXR1cm4gcmVzcG9uc2U7XG4gIH1cbiAgY29uc3QgbWVzc2FnZSA9IHJlc3BvbnNlLmhlYWRlcnMuZ2V0KCdYLU1lc3NhZ2UnKTtcbiAgaWYgKG1lc3NhZ2UpIHtcbiAgICB0aHJvdyBuZXcgSHR0cEVycm9yKHJlc3BvbnNlLCBtZXNzYWdlKTtcbiAgfVxuICB0aHJvdyBuZXcgSHR0cEVycm9yKHJlc3BvbnNlKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGh0dHBHZXRKc29uPFQ+KHVyaTogc3RyaW5nKSB7XG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgaHR0cEdldCh1cmkpO1xuICByZXR1cm4gPFQ+KGF3YWl0IHJlc3BvbnNlLmpzb24oKSk7XG59Il19