const decorators = [];
const doFetch = (decorators, uri, init) => {
    let opts = init || {};
    for (const decorator of decorators) {
        const newOpts = decorator.decorate(uri, opts);
        if (newOpts) {
            opts = newOpts;
        }
    }
    return window.fetch(uri, opts);
};
export const decoratedFetch = Object.assign(Object.defineProperty((uri, init) => doFetch(decorators, uri, init), 'decorators', {
    get() { return decorators; }
}), {
    native: window.fetch.bind(window),
    include: (input) => {
        const ds = [];
        for (const key of input) {
            if ('string' === typeof key) {
                const d = decorators.find(x => x.name === key);
                if (!d) {
                    throw new Error('invalid or missing decorator: ' + key);
                }
                ds.push(d);
            }
            else {
                ds.push(key);
            }
        }
        return (uri, init) => doFetch(ds, uri, init);
    },
    exclude: (input) => {
        const ds = decorators.slice(0);
        for (const key of input) {
            if ('string' === typeof key) {
                const index = ds.findIndex(x => x.name === key);
                if (-1 !== index) {
                    ds.splice(index, 1);
                }
            }
            else {
                const index = ds.findIndex(x => x === key);
                if (-1 !== index) {
                    ds.splice(index, 1);
                }
            }
        }
        return (uri, init) => doFetch(ds, uri, init);
    }
});
export class HttpError extends Error {
    constructor(response, message) {
        super(message);
        Object.setPrototypeOf(this, HttpError.prototype);
        if ('function' === typeof Error.captureStackTrace) {
            Error.captureStackTrace(this, this.constructor);
        }
        this.response = response;
    }
}
const defaultErrors = {
    400: 'Bad request',
    500: 'Server error'
};
export async function httpGet(uri) {
    const response = await decoratedFetch(uri, { method: 'GET' });
    if (response.ok) {
        return response;
    }
    const message = response.headers.get('X-Message');
    if (message) {
        throw new HttpError(response, message);
    }
    throw new HttpError(response, defaultErrors[response.status] || `Unexpected error while fetching ${uri}`);
}
export async function httpGetJson(uri) {
    const response = await httpGet(uri);
    return (await response.json());
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmV0Y2guanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZmV0Y2gudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBa0JBLE1BQU0sVUFBVSxHQUFxQixFQUFFLENBQUM7QUFFeEMsTUFBTSxPQUFPLEdBQUcsQ0FBQyxVQUE0QixFQUFFLEdBQVcsRUFBRSxJQUEwQixFQUFFLEVBQUU7SUFDeEYsSUFBSSxJQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUN0QixLQUFLLE1BQU0sU0FBUyxJQUFJLFVBQVUsRUFBRTtRQUNsQyxNQUFNLE9BQU8sR0FBRyxTQUFTLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUM5QyxJQUFJLE9BQU8sRUFBRTtZQUNYLElBQUksR0FBRyxPQUFPLENBQUM7U0FDaEI7S0FDRjtJQUNELE9BQU8sTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDakMsQ0FBQyxDQUFDO0FBT0YsTUFBTSxDQUFDLE1BQU0sY0FBYyxHQUFtQixNQUFNLENBQUMsTUFBTSxDQUNoRCxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUMsR0FBVyxFQUFFLElBQTBCLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLFlBQVksRUFBRTtJQUN4SCxHQUFHLEtBQUssT0FBTyxVQUFVLENBQUEsQ0FBQyxDQUFDO0NBQzVCLENBQUMsRUFBRTtJQUNGLE1BQU0sRUFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7SUFDakMsT0FBTyxFQUFFLENBQUMsS0FBZ0MsRUFBRSxFQUFFO1FBQzVDLE1BQU0sRUFBRSxHQUFxQixFQUFFLENBQUM7UUFDaEMsS0FBSyxNQUFNLEdBQUcsSUFBSSxLQUFLLEVBQUU7WUFDdkIsSUFBSSxRQUFRLEtBQUssT0FBTyxHQUFHLEVBQUU7Z0JBQzNCLE1BQU0sQ0FBQyxH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QUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxtQ0FBbUMsR0FBRyxFQUFFLENBQUMsQ0FBQztBQUM1RyxDQUFDO0FBRUQsTUFBTSxDQUFDLEtBQUssVUFBVSxXQUFXLENBQUksR0FBVztJQUM5QyxNQUFNLFFBQVEsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNwQyxPQUFVLENBQUMsTUFBTSxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztBQUNwQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiXG5leHBvcnQgaW50ZXJmYWNlIEZldGNoRGVjb3JhdG9yIHtcbiAgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuICBkZWNvcmF0ZTxUIGV4dGVuZHMgUmVxdWVzdEluaXQ+KHVyaTogc3RyaW5nLCBpbml0OiBUKTogVHx2b2lkO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFueVByb3Age1xuICBba2V5OiBzdHJpbmddOiBhbnlcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEZWNvcmF0ZWRGZXRjaCB7XG4gICh1cmk6IHN0cmluZywgaW5pdDogUmVxdWVzdEluaXQmQW55UHJvcCk6IFByb21pc2U8UmVzcG9uc2U+O1xuICByZWFkb25seSBkZWNvcmF0b3JzOiBGZXRjaERlY29yYXRvcltdO1xuICBuYXRpdmUodXJpOiBzdHJpbmcsIGluaXQ6IFJlcXVlc3RJbml0KTogUHJvbWlzZTxSZXNwb25zZT47XG4gIGluY2x1ZGUoZGVjb3JhdG9yczogKHN0cmluZ3xGZXRjaERlY29yYXRvcilbXSk6ICh1cmk6IHN0cmluZywgaW5pdDogUmVxdWVzdEluaXQmQW55UHJvcCkgPT4gUHJvbWlzZTxSZXNwb25zZT47XG4gIGV4Y2x1ZGUoZGVjb3JhdG9yczogKHN0cmluZ3xGZXRjaERlY29yYXRvcilbXSk6ICh1cmk6IHN0cmluZywgaW5pdDogUmVxdWVzdEluaXQmQW55UHJvcCkgPT4gUHJvbWlzZTxSZXNwb25zZT47XG59XG5cbmNvbnN0IGRlY29yYXRvcnM6IEZldGNoRGVjb3JhdG9yW10gPSBbXTtcblxuY29uc3QgZG9GZXRjaCA9IChkZWNvcmF0b3JzOiBGZXRjaERlY29yYXRvcltdLCB1cmk6IHN0cmluZywgaW5pdD86IFJlcXVlc3RJbml0JkFueVByb3ApID0+IHtcbiAgbGV0IG9wdHMgPSBpbml0IHx8IHt9O1xuICBmb3IgKGNvbnN0IGRlY29yYXRvciBvZiBkZWNvcmF0b3JzKSB7XG4gICAgY29uc3QgbmV3T3B0cyA9IGRlY29yYXRvci5kZWNvcmF0ZSh1cmksIG9wdHMpO1xuICAgIGlmIChuZXdPcHRzKSB7XG4gICAgICBvcHRzID0gbmV3T3B0cztcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHdpbmRvdy5mZXRjaCh1cmksIG9wdHMpO1xufTtcblxuaW50ZXJmYWNlIEluaXRpYWwge1xuICAodXJpOiBzdHJpbmcsIGluaXQ6IFJlcXVlc3RJbml0JkFueVByb3ApOiBQcm9taXNlPFJlc3BvbnNlPjtcbiAgcmVhZG9ubHkgZGVjb3JhdG9yczogRmV0Y2hEZWNvcmF0b3JbXVxufVxuXG5leHBvcnQgY29uc3QgZGVjb3JhdGVkRmV0Y2g6IERlY29yYXRlZEZldGNoID0gT2JqZWN0LmFzc2lnbihcbiAgPEluaXRpYWw+T2JqZWN0LmRlZmluZVByb3BlcnR5KCh1cmk6IHN0cmluZywgaW5pdD86IFJlcXVlc3RJbml0JkFueVByb3ApID0+IGRvRmV0Y2goZGVjb3JhdG9ycywgdXJpLCBpbml0KSwgJ2RlY29yYXRvcnMnLCB7XG4gICAgZ2V0KCkgeyByZXR1cm4gZGVjb3JhdG9ycyB9XG4gIH0pLCB7XG4gICAgbmF0aXZlOiB3aW5kb3cuZmV0Y2guYmluZCh3aW5kb3cpLFxuICAgIGluY2x1ZGU6IChpbnB1dDogKHN0cmluZ3xGZXRjaERlY29yYXRvcilbXSkgPT4ge1xuICAgICAgY29uc3QgZHM6IEZldGNoRGVjb3JhdG9yW10gPSBbXTtcbiAgICAgIGZvciAoY29uc3Qga2V5IG9mIGlucHV0KSB7XG4gICAgICAgIGlmICgnc3RyaW5nJyA9PT0gdHlwZW9mIGtleSkge1xuICAgICAgICAgIGNvbnN0IGQgPSBkZWNvcmF0b3JzLmZpbmQoeCA9PiB4Lm5hbWUgPT09IGtleSk7XG4gICAgICAgICAgaWYgKCFkKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgb3IgbWlzc2luZyBkZWNvcmF0b3I6ICcgKyBrZXkpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBkcy5wdXNoKGQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGRzLnB1c2goa2V5KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuICh1cmk6IHN0cmluZywgaW5pdD86IFJlcXVlc3RJbml0JkFueVByb3ApID0+IGRvRmV0Y2goZHMsIHVyaSwgaW5pdCk7XG4gICAgfSxcbiAgICBleGNsdWRlOiAoaW5wdXQ6IChzdHJpbmd8RmV0Y2hEZWNvcmF0b3IpW10pID0+IHtcbiAgICAgIGNvbnN0IGRzOiBGZXRjaERlY29yYXRvcltdID0gZGVjb3JhdG9ycy5zbGljZSgwKTtcbiAgICAgIGZvciAoY29uc3Qga2V5IG9mIGlucHV0KSB7XG4gICAgICAgIGlmICgnc3RyaW5nJyA9PT0gdHlwZW9mIGtleSkge1xuICAgICAgICAgIGNvbnN0IGluZGV4ID0gZHMuZmluZEluZGV4KHggPT4geC5uYW1lID09PSBrZXkpO1xuICAgICAgICAgIGlmICgtMSAhPT0gaW5kZXgpIHtcbiAgICAgICAgICAgIGRzLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IGluZGV4ID0gZHMuZmluZEluZGV4KHggPT4geCA9PT0ga2V5KTtcbiAgICAgICAgICBpZiAoLTEgIT09IGluZGV4KSB7XG4gICAgICAgICAgICBkcy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuICh1cmk6IHN0cmluZywgaW5pdD86IFJlcXVlc3RJbml0JkFueVByb3ApID0+IGRvRmV0Y2goZHMsIHVyaSwgaW5pdCk7XG4gICAgfVxuICB9XG4pO1xuXG5leHBvcnQgY2xhc3MgSHR0cEVycm9yIGV4dGVuZHMgRXJyb3Ige1xuICByZXNwb25zZTogUmVzcG9uc2U7XG4gIGNvbnN0cnVjdG9yKHJlc3BvbnNlOiBSZXNwb25zZSwgbWVzc2FnZTogc3RyaW5nKSB7XG4gICAgc3VwZXIobWVzc2FnZSk7XG4gICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKHRoaXMsIEh0dHBFcnJvci5wcm90b3R5cGUpO1xuICAgIGlmICgnZnVuY3Rpb24nID09PSB0eXBlb2YgKDxhbnk+RXJyb3IpLmNhcHR1cmVTdGFja1RyYWNlKSB7XG4gICAgICAoPGFueT5FcnJvcikuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgdGhpcy5jb25zdHJ1Y3Rvcik7XG4gICAgfVxuICAgIHRoaXMucmVzcG9uc2UgPSByZXNwb25zZTtcbiAgfVxufVxuXG5jb25zdCBkZWZhdWx0RXJyb3JzOiB7IFtrZXk6IG51bWJlcl06IHN0cmluZ3x1bmRlZmluZWQgfSA9IHtcbiAgNDAwOiAnQmFkIHJlcXVlc3QnLFxuICA1MDA6ICdTZXJ2ZXIgZXJyb3InXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBodHRwR2V0KHVyaTogc3RyaW5nKSB7XG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZGVjb3JhdGVkRmV0Y2godXJpLCB7IG1ldGhvZDogJ0dFVCcgfSk7XG4gIGlmIChyZXNwb25zZS5vaykge1xuICAgIHJldHVybiByZXNwb25zZTtcbiAgfVxuICBjb25zdCBtZXNzYWdlID0gcmVzcG9uc2UuaGVhZGVycy5nZXQoJ1gtTWVzc2FnZScpO1xuICBpZiAobWVzc2FnZSkge1xuICAgIHRocm93IG5ldyBIdHRwRXJyb3IocmVzcG9uc2UsIG1lc3NhZ2UpO1xuICB9XG4gIHRocm93IG5ldyBIdHRwRXJyb3IocmVzcG9uc2UsIGRlZmF1bHRFcnJvcnNbcmVzcG9uc2Uuc3RhdHVzXSB8fCBgVW5leHBlY3RlZCBlcnJvciB3aGlsZSBmZXRjaGluZyAke3VyaX1gKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGh0dHBHZXRKc29uPFQ+KHVyaTogc3RyaW5nKSB7XG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgaHR0cEdldCh1cmkpO1xuICByZXR1cm4gPFQ+KGF3YWl0IHJlc3BvbnNlLmpzb24oKSk7XG59Il19